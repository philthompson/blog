var twoPi=2*Math.PI,negativeHalfPie=-.5*Math.PI,srcImgData=null,iteration=0,iterateTimeout=null,resizeCheckCounter=0,sCanvas=document.getElementById("sc"),dCanvas=document.getElementById("dc"),sContext=sCanvas.getContext("2d"),dContext=dCanvas.getContext("2d");dContext.globalCompositeOperation="destination-over";var width=0,height=0,dOffsetX=0,dOffsetY=0,dScale=0,transparency=.3,endTransparency=0,radiusSize=0,maxRadiusSizePercent=.1,maxIterations=3e4,iterSpeed=5,initialPauseBeforeStartMs=100,finalPauseBeforeStartMs=2e3,pauseBeforeStartMs=initialPauseBeforeStartMs,totalImages=0,imageNumber=0,started=!1,running=!1,filesInput=document.getElementById("fi"),body=document.getElementsByTagName("body")[0],demo=document.getElementById("demo"),demoImages=document.getElementsByClassName("demo-img").length,isDemo=!1;function closeMenu(){document.getElementById("menu").style.display="none",document.getElementById("menu-open-wrap").style.display="block"}function openMenu(){document.getElementById("menu").style.display="block",document.getElementById("menu-open-wrap").style.display="none"}function clearImages(){for(;document.getElementsByTagName("img").length>demoImages;)for(var e=document.getElementsByTagName("img"),t=0;t<e.length;t++)e[t].className.indexOf("demo-img")<0&&body.removeChild(e[t]);totalImages=demoImages}function resetIntroText(){window.clearTimeout(iterateTimeout),setDScaleVars(!0,dContext),fillCenterText(dContext,"Drag images here"),fillCenterSubtext(dContext,"or click or tap to select images"),demo.style.display="inline-block",imageNumber=totalImages=0,iteration=maxIterations,running=started=isDemo=!1,pauseBeforeStartMs=initialPauseBeforeStartMs}function setFiles(e){if(0!=e.length){clearImages();for(var t=0,a=0;a<e.length;a++){var i=e[a];if(i.type.startsWith("image/")){t+=1;var n=document.createElement("img");n.classList.add("obj"),n.file=i,body.appendChild(n);var o=new FileReader;if(o.onload=function(t){return function(e){t.src=e.target.result}}(n),o.readAsDataURL(i),100<=a)break}}totalImages=t+demoImages,isDemo=!1,initThenStart()}}function startDemo(){totalImages=demoImages,isDemo=!0,initThenStart()}function initThenStart(){imageNumber=0,iteration=maxIterations,started=!1,pauseBeforeStartMs=initialPauseBeforeStartMs,demo.style.display="none",window.clearTimeout(iterateTimeout),running=!0,start()}document.getElementById("reset").addEventListener("click",function(e){clearImages(),resetIntroText(),closeMenu()},!0),document.getElementById("demo").addEventListener("click",function(e){clearImages(),closeMenu(),startDemo()},!0),dCanvas.addEventListener("click",function(e){0==totalImages&&filesInput.click()},!0),dCanvas.addEventListener("dragenter",function(e){e.stopPropagation(),e.preventDefault()},!1),dCanvas.addEventListener("dragover",function(e){e.stopPropagation(),e.preventDefault()},!1),dCanvas.addEventListener("drop",function(e){e.stopPropagation(),e.preventDefault(),setFiles(e.dataTransfer.files)},!1),document.getElementById("menu-open").addEventListener("click",function(e){openMenu()},!0),document.getElementById("menu-close").addEventListener("click",function(e){closeMenu()},!0);var getData=function(e){return sCanvas.width=e.width,sCanvas.height=e.height,sCanvas.style.width=e.width,sCanvas.style.height=e.height,width=sCanvas.width,height=sCanvas.height,sContext.drawImage(e,0,0),sContext.getImageData(0,0,width,height)};function isImageLoaded(e){return!!e.complete&&(void 0===e.naturalWidth||0!==e.naturalWidth)}var start=function(){if(!running)return started=!1,void window.clearTimeout(iterateTimeout);started||(window.clearTimeout(iterateTimeout),setDScaleVars(!1,dContext),fillCenterText(dContext,"Loading...")),0==totalImages&&(resetIntroText(),started=!1),totalImages<++imageNumber&&(imageNumber=1);var e=document.getElementsByTagName("img")[imageNumber-1];!isDemo&&0<=e.className.indexOf("demo-img")?window.setTimeout(start,5):null!=e&&isImageLoaded(e)?(window.setTimeout(function(){srcImgData=getData(e),setDScaleVars(!1,dContext),started?fillBlackSlowlyThenIterate(dContext):(started=!0,fillBlack(dContext),iteration=0,iterate())},pauseBeforeStartMs),pauseBeforeStartMs=finalPauseBeforeStartMs):window.setTimeout(start,1e3)},pixelColor=function(e,t,a){return[e.data[4*(width*a+t)],e.data[4*(width*a+t)+1],e.data[4*(width*a+t)+2]]};function fillBlack(e){var t=e.canvas;e.fillStyle="#000000",e.fillRect(0,0,t.width,t.height)}function fillBlackSlowlyThenIterate(e){var t=e.canvas,a=0,i=80*iterSpeed,n=function(){a+=1,fillCircle(Math.floor(Math.random()*t.width),Math.floor(Math.random()*t.height),3*radiusSize/2,[0,0,0],dContext),a<1e3&&started?((i*=.96)<iterSpeed&&(i=iterSpeed),iterateTimeout=window.setTimeout(n,i)):started&&(fillBlack(e),iteration=0,iterate())};n()}function fillCenterText(e,t){fillBlack(e);var a=e.canvas,i=Math.min(a.width,a.height)/12;i<8&&(i=8),e.font=i+"px Arial",e.fillStyle="#444444",e.textAlign="center",e.fillText(t,a.width/2,a.height/2)}function fillCenterSubtext(e,t){var a=e.canvas,i=Math.min(a.width,a.height)/25;i<5&&(i=5),e.font=i+"px Arial",e.fillStyle="#444444",e.textAlign="center",e.fillText(t,a.width/2,12*a.height/20)}function setDScaleVars(e,t){var a=t.canvas;!e&&a.width==a.offsetWidth&&a.height==a.offsetHeight||(a.width=a.offsetWidth,a.height=a.offsetHeight,radiusSize=Math.floor(Math.max(a.width,a.height)*maxRadiusSizePercent),iteration=0,fillBlack(t));var i=width/height,n=a.width,o=n/i;dOffsetY=dOffsetX=0,dScale=n/width,o>a.height?(o=a.height,dScale=(n=o*i)/width,dOffsetX=(a.width-n)/2):dOffsetY=(a.height-o)/2}function fillCircleFlat(e,t,a,i,n){n.fillStyle="rgba("+i[0]+","+i[1]+","+i[2]+", "+transparency+")",n.beginPath(),n.arc(e,t,a,0,twoPi),n.fill()}function fillCircle(e,t,a,i,n){var o="rgba("+i[0]+","+i[1]+","+i[2]+", "+transparency+")",r="rgba("+i[0]+","+i[1]+","+i[2]+", "+endTransparency+")",l=n.createRadialGradient(e,t,0,e,t,a);l.addColorStop(0,o),l.addColorStop(1,r),n.fillStyle=l,n.beginPath(),n.arc(e,t,a,0,twoPi),n.fill()}function fillPie(e,t){var a=t.canvas,i=Math.floor(.005*Math.max(a.width,a.height)),n=Math.floor(3*i),o=n;t.fillStyle="rgba(0, 0, 0, 1.0)",t.beginPath(),t.arc(n,o,i+1,0,twoPi),t.fill(),t.fillStyle="rgba(255, 255, 255, "+transparency+")",t.beginPath(),t.moveTo(n,o),t.lineTo(n,o-i),t.arc(n,o,i,negativeHalfPie,negativeHalfPie+twoPi*e),t.lineTo(n,o),t.fill()}var iterate=function(){++iteration,100==resizeCheckCounter&&(setDScaleVars(!1,dContext),fillPie(iteration/maxIterations,dContext),resizeCheckCounter=0),++resizeCheckCounter;var e=Math.floor(Math.random()*width),t=Math.floor(Math.random()*height),a=pixelColor(srcImgData,e,t);fillCircle(dOffsetX+Math.floor(e*dScale),dOffsetY+Math.floor(t*dScale),Math.max(Math.ceil(6*Math.random())+1,Math.ceil((.85*maxIterations-iteration)/maxIterations*radiusSize)),a,dContext),iteration<maxIterations?iterateTimeout=window.setTimeout(iterate,iterSpeed):start()};resetIntroText();