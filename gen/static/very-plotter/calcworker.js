// as of 2021-11-09, minify with https://codebeautify.org/minify-js
var useWorkers=!0;self.Worker||(useWorkers=!1,self.postMessage({subworkerNoWorky:!0}),self.close());const forceWorkerReloadUrlParam="force-worker-reload=true",forceWorkerReload=self.location.toString().includes(forceWorkerReloadUrlParam),urlParams=new URLSearchParams(self.location.search),appVersion=urlParams.has("v")?urlParams.get("v"):"unk";forceWorkerReload?(importScripts("infnum.js?v="+appVersion+"&"+"force-worker-reload=true&t="+Date.now()),importScripts("plots.js?v="+appVersion+"&"+"force-worker-reload=true&t="+Date.now())):(importScripts("infnum.js?v="+appVersion),importScripts("plots.js?v="+appVersion));const plotsByName={};for(let e=0;e<plots.length;e++)plotsByName[plots[e].name]=plots[e];const allCachedIndicesArray=[-1],windowCalc={timeout:null,plot:null,pointCalcFunction:null,eachPixUnits:null,edges:null,n:null,precision:null,algorithm:null,lineWidth:null,finalWidth:null,chunksComplete:null,canvasWidth:null,canvasHeight:null,xPixelChunks:null,pointsCache:null,pointsCacheAlgorithm:null,cacheScannedChunks:null,cacheScannedChunksCursor:null,passTotalPoints:null,passCachedPoints:null,totalChunks:null,workersCount:null,workers:null,minWorkersCount:null,maxWorkersCount:null,plotId:null,stopped:!0,referencePx:null,referencePy:null,referenceOrbit:null,referenceOrbitPrecision:null,referenceOrbitN:null,referenceBlaTables:null,referenceBlaN:null,saCoefficients:null,saCoefficientsN:null,saCoefficientsEdges:null,saCoefficientsParams:null,passBlaPixels:null,passBlaIterationsSkipped:null,passBlaSkips:null,setupStage:null,setupStageState:null,setupStageIsStarted:null,setupStageIsFinished:null},setupStages={checkRefOrbit:0,calcRefOrbit:1,checkBlaCoeff:2,calcBlaCoeff:3,checkSaCoeff:4,calcSaCoeff:5,done:6};function runCalc(e){windowCalc.plotId=e.plotId,windowCalc.plot=e.plot,windowCalc.stopped=!1,windowCalc.eachPixUnits=e.eachPixUnits,windowCalc.edges={left:e.leftEdge,right:e.rightEdge,top:e.topEdge,bottom:e.bottomEdge},windowCalc.n=e.n,windowCalc.precision=e.precision,windowCalc.algorithm=e.algorithm,windowCalc.lineWidth=2*e.startWidth,windowCalc.finalWidth=e.finalWidth,windowCalc.chunksComplete=0,windowCalc.canvasWidth=e.canvasWidth,windowCalc.canvasHeight=e.canvasHeight,(null===windowCalc.pointsCache||null!==windowCalc.pointsCacheAlgorithm&&windowCalc.pointsCacheAlgorithm!=windowCalc.algorithm)&&(windowCalc.pointsCache=new Map),windowCalc.pointsCacheAlgorithm=windowCalc.algorithm,windowCalc.totalChunks=null,windowCalc.workersCount=e.workers,windowCalc.workers=[],windowCalc.minWorkersCount=windowCalc.workersCount,windowCalc.maxWorkersCount=windowCalc.workersCount;for(let e=0;e<windowCalc.workersCount;e++)forceWorkerReload?windowCalc.workers.push(new Worker("calcsubworker.js?v="+appVersion+"&"+"force-worker-reload=true&t="+Date.now())):windowCalc.workers.push(new Worker("calcsubworker.js?v="+appVersion)),windowCalc.workers[e].onmessage=onSubWorkerMessage;windowCalc.algorithm.includes("basic-")?(windowCalc.referencePx=null,windowCalc.referencePy=null,windowCalc.referenceOrbit=null,windowCalc.referenceBlaTables=null,windowCalc.saCoefficients=null,calculatePass()):(null!=windowCalc.timeout&&clearTimeout(windowCalc.timeout),windowCalc.timeout=setTimeout(kickoffSetupTasks,250))}function setupCheckReferenceOrbit(){sendStatusMessage("Finding reference point");let e=infNumAdd(windowCalc.edges.left,infNumMul(windowCalc.eachPixUnits,infNum(BigInt(Math.floor(windowCalc.canvasWidth/2)),0n))),n=infNumAdd(windowCalc.edges.bottom,infNumMul(windowCalc.eachPixUnits,infNum(BigInt(Math.floor(windowCalc.canvasHeight/2)),0n))),o=!1;if(null===windowCalc.referencePx||null===windowCalc.referencePy)o=!0;else{let a=infNumSub(windowCalc.referencePx,e),t=infNumSub(windowCalc.referencePy,n),i=infNumAdd(infNumMul(a,a),infNumMul(t,t)),l=Math.ceil(.05*windowCalc.canvasWidth),s=infNumMul(windowCalc.eachPixUnits,infNum(BigInt(l),0n));s=infNumMul(s,s),infNumGt(i,s)?(o=!0,console.log("the previous ref orbit is NOT within ["+l+"] pixels, so we need a new ref orbit")):console.log("the previous ref orbit is within ["+l+"] pixels, so it's still valid")}return null===windowCalc.referenceOrbitN||windowCalc.referenceOrbitN<windowCalc.n||null===windowCalc.referenceOrbitPrecision||windowCalc.referenceOrbitPrecision/windowCalc.precision<.98||null===windowCalc.referenceOrbit||o?(windowCalc.referencePx=e,windowCalc.referencePy=n,windowCalc.referenceOrbit=null,windowCalc.saCoefficients=null,windowCalc.referenceBlaTables=null,!0):(console.log("re-using previously-calculated reference orbit, with ["+windowCalc.referenceOrbit.length+"] iterations, for point:"),console.log("referencePx: "+infNumToString(windowCalc.referencePx)),console.log("referencePy: "+infNumToString(windowCalc.referencePy)),!1)}function setupReferenceOrbit(e){return null!==e&&e.done||sendStatusMessage((e=plotsByName[windowCalc.plot].computeReferenceOrbit(windowCalc.n,windowCalc.precision,windowCalc.algorithm,windowCalc.referencePx,windowCalc.referencePy,e)).status),e.done&&(windowCalc.referenceOrbit=e.orbit,windowCalc.referenceOrbitN=windowCalc.n,windowCalc.referenceOrbitPrecision=windowCalc.precision,console.log("calculated new middle reference orbit, with ["+windowCalc.referenceOrbit.length+"] iterations, for point:"),console.log("referencePx: "+infNumToString(windowCalc.referencePx)),console.log("referencePy: "+infNumToString(windowCalc.referencePy))),e}function setupCheckBlaCoefficients(){if(windowCalc.algorithm.includes("bla-")){if(null===windowCalc.referenceBlaTables||windowCalc.n!==windowCalc.referenceBlaN)return!0;console.log("re-using previously-calculated BLA coefficient tables")}return!1}function setupBlaCoefficients(e){return null!==e&&e.done||(null===e&&(windowCalc.referenceBlaTables,sendStatusMessage("Calculating BLA coefficient tables")),sendStatusMessage((e=plotsByName[windowCalc.plot].computeBlaTables(windowCalc.algorithm,windowCalc.referenceOrbit,e)).status)),e.done&&(windowCalc.referenceBlaN=windowCalc.n,windowCalc.referenceBlaTables=e.blaTables),e}function setupCheckSaCoefficients(){if(windowCalc.algorithm.includes("sapx")){let e=windowCalc.algorithm.split("-").find((e=>e.startsWith("sapx")));if(!(null!==windowCalc.saCoefficients&&null!==windowCalc.saCoefficientsEdges&&windowCalc.n===windowCalc.saCoefficientsN&&null!==windowCalc.saCoefficientsParams&&windowCalc.saCoefficientsParams==e&&infNumEq(windowCalc.edges.left,windowCalc.saCoefficientsEdges.left)&&infNumEq(windowCalc.edges.right,windowCalc.saCoefficientsEdges.right)&&infNumEq(windowCalc.edges.top,windowCalc.saCoefficientsEdges.top)&&infNumEq(windowCalc.edges.bottom,windowCalc.saCoefficientsEdges.bottom)))return!0;console.log("re-using previously-calculated SA coefficients")}return!1}function setupSaCoefficients(e){return null!==e&&e.done||(null===e&&(windowCalc.saCoefficients,sendStatusMessage("Calculating and testing SA coefficients")),sendStatusMessage((e=plotsByName[windowCalc.plot].computeSaCoefficients(windowCalc.precision,windowCalc.algorithm,windowCalc.referencePx,windowCalc.referencePy,windowCalc.referenceOrbit,windowCalc.edges,e)).status)),e.done&&(windowCalc.saCoefficientsN=windowCalc.n,windowCalc.saCoefficientsEdges=structuredClone(windowCalc.edges),windowCalc.saCoefficients=e.saCoefficients,windowCalc.saCoefficientsParams=windowCalc.algorithm.split("-").find((e=>e.startsWith("sapx")))),e}function kickoffSetupTasks(){null!=windowCalc.timeout&&clearTimeout(windowCalc.timeout),windowCalc.setupStage=0,windowCalc.timeout=setInterval(runSetupTasks,5)}function runSetupTasks(){if(windowCalc.stopped||windowCalc.setupStage>=setupStages.done)return null!=windowCalc.timeout&&clearTimeout(windowCalc.timeout),void(windowCalc.stopped||calculatePass());windowCalc.setupStage===setupStages.checkRefOrbit?(setupCheckReferenceOrbit()||windowCalc.setupStage++,windowCalc.setupStageIsFinished=!0):windowCalc.setupStage===setupStages.calcRefOrbit?(windowCalc.setupStageIsStarted||(windowCalc.setupStageState=null,windowCalc.setupStageIsStarted=!0),windowCalc.setupStageIsFinished||(windowCalc.setupStageState=setupReferenceOrbit(windowCalc.setupStageState)),windowCalc.setupStageState.done&&(windowCalc.setupStageIsFinished=!0)):windowCalc.setupStage===setupStages.checkBlaCoeff?(setupCheckBlaCoefficients()||windowCalc.setupStage++,windowCalc.setupStageIsFinished=!0):windowCalc.setupStage===setupStages.calcBlaCoeff?(windowCalc.setupStageIsStarted||(windowCalc.setupStageState=null,windowCalc.setupStageIsStarted=!0),windowCalc.setupStageIsFinished||(windowCalc.setupStageState=setupBlaCoefficients(windowCalc.setupStageState)),windowCalc.setupStageState.done&&(windowCalc.setupStageIsFinished=!0)):windowCalc.setupStage===setupStages.checkSaCoeff?(setupCheckSaCoefficients()||windowCalc.setupStage++,windowCalc.setupStageIsFinished=!0):windowCalc.setupStage===setupStages.calcSaCoeff?(windowCalc.setupStageIsStarted||(windowCalc.setupStageState=null,windowCalc.setupStageIsStarted=!0),windowCalc.setupStageIsFinished||(windowCalc.setupStageState=setupSaCoefficients(windowCalc.setupStageState)),windowCalc.setupStageState.done&&(windowCalc.setupStageIsFinished=!0)):(console.log("unexpected calcworker setup stage ["+windowCalc.setupStage+"]... stopping setup"),windowCalc.setupStage=setupStages.done),windowCalc.setupStageIsFinished&&(windowCalc.setupStageIsStarted=!1,windowCalc.setupStageIsFinished=!1,windowCalc.setupStage++)}function stopAndRemoveAllWorkers(){if(null!=windowCalc.timeout&&clearTimeout(windowCalc.timeout),null!==windowCalc.workers){for(let e=0;e<windowCalc.workers.length;e++)windowCalc.workers[e].terminate();windowCalc.workers=null}}function updateWorkerCount(e){if(windowCalc.workersCount=e,null!==windowCalc.workers){windowCalc.minWorkersCount>windowCalc.workersCount&&(windowCalc.minWorkersCount=windowCalc.workersCount),windowCalc.maxWorkersCount<windowCalc.workersCount&&(windowCalc.maxWorkersCount=windowCalc.workersCount);for(let e=windowCalc.workers.length+1;e<=windowCalc.workersCount;e++){let e=null;e=forceWorkerReload?new Worker("calcsubworker.js?v="+appVersion+"&"+"force-worker-reload=true&t="+Date.now()):new Worker("calcsubworker.js?v="+appVersion),windowCalc.workers.push(e),e.onmessage=onSubWorkerMessage,assignChunkToWorker(e)}}}function removeWorkerIfNecessary(e){if(windowCalc.workers.length<=windowCalc.workersCount)return!1;const n=windowCalc.workers.indexOf(e);return!(n<0)&&(windowCalc.workers.splice(n,1),!0)}self.onmessage=function(e){useWorkers?(console.log("got mesage ["+e.data.t+"]"),"worker-calc"==e.data.t?runCalc(e.data.v):"workers-count"==e.data.t?updateWorkerCount(e.data.v):"wipe-cache"==e.data.t?windowCalc.pointsCache=new Map:"stop"==e.data.t&&(windowCalc.stopped=!0,stopAndRemoveAllWorkers())):self.postMessage({subworkerNoWorky:!0})};var calculatePass=function(){if(!windowCalc.stopped){calculateWindowPassChunks();for(const e of windowCalc.workers)assignChunkToWorker(e)}};function buildChunkId(e){return infNumFastStr(e.x)+","+infNumFastStr(e.y)}var assignChunkToWorker=function(e){if(windowCalc.stopped||null===windowCalc.xPixelChunks||0===windowCalc.xPixelChunks.length)return;let n=windowCalc.xPixelChunks.shift();windowCalc.cacheScannedChunksCursor--;const o=buildChunkId(n.chunkPos);let a=windowCalc.cacheScannedChunks.get(o);void 0===a&&(scanCacheForChunk(n),a=windowCalc.cacheScannedChunks.get(o));let t={plotId:windowCalc.plotId,chunk:n,cachedIndices:a.size===n.chunkLen?allCachedIndicesArray:Array.from(a.keys()).sort(((e,n)=>e-n))};e.postMessage({t:"compute-chunk",v:t}),scanCacheForChunkBeyondCursor(),scanCacheForChunkBeyondCursor()};function scanCacheForChunkBeyondCursor(){windowCalc.cacheScannedChunksCursor>=windowCalc.xPixelChunks.length-1||0===windowCalc.xPixelChunks.length||(windowCalc.cacheScannedChunksCursor++,windowCalc.cacheScannedChunksCursor<0&&(windowCalc.cacheScannedChunksCursor=0),scanCacheForChunk(windowCalc.xPixelChunks[windowCalc.cacheScannedChunksCursor]))}function scanCacheForChunk(e){const n=infNumFastStr(e.chunkPos.x),o=n+","+infNumFastStr(e.chunkPos.y);let a=e.chunkPos.y,t=e.chunkInc.y,i=normInfNum(a,t);a=i[0],t=i[1];const l=new Map;let s=null;const c=windowCalc.pointsCache.get(n);if(void 0!==c)for(let n=0;n<e.chunkLen;n++)s=c.get(infNumFastStr(a)),void 0!==s&&l.set(n,s),a=infNumAddNorm(a,t);windowCalc.cacheScannedChunks.set(o,l)}function cacheComputedPointsInChunk(e){if(0===e.results.length)return 0;let n=0;const o=infNumFastStr(e.chunkPos.x);let a=windowCalc.pointsCache.get(o);void 0===a&&(windowCalc.pointsCache.set(o,new Map),a=windowCalc.pointsCache.get(o));let t=e.chunkPos.y,i=e.chunkInc.y,l=normInfNum(t,i);t=l[0],i=l[1];let s=null;for(let o=0;o<e.chunkLen;o++)s=e.results[o],void 0!==s&&(n++,a.set(infNumFastStr(t),s)),t=infNumAddNorm(t,i);return n}var onSubWorkerMessage=function(n){"completed-chunk"==n.data.t?handleSubworkerCompletedChunk(n):"send-reference-orbit"==n.data.t?handleReferenceOrbitRequest(n):"send-bla-tables"==n.data.t?handleBlaTablesRequest(n):"send-sa-coefficients"==n.data.t?handleSaCoefficientsRequest(n):console.log("worker received unknown message from subworker:",e)};function handleReferenceOrbitRequest(e){e.target.postMessage({t:"reference-orbit",v:{referencePx:windowCalc.referencePx,referencePy:windowCalc.referencePy,referenceOrbit:windowCalc.referenceOrbit,referencePlotId:windowCalc.plotId}})}function handleBlaTablesRequest(e){e.target.postMessage({t:"bla-tables",v:{referencePx:windowCalc.referencePx,referencePy:windowCalc.referencePy,referenceBlaTables:windowCalc.referenceBlaTables,referencePlotId:windowCalc.plotId}})}function handleSaCoefficientsRequest(e){e.target.postMessage({t:"sa-coefficients",v:{referencePx:windowCalc.referencePx,referencePy:windowCalc.referencePy,saCoefficients:windowCalc.saCoefficients,referencePlotId:windowCalc.plotId}})}function handleSubworkerCompletedChunk(e){const n=e.data.v.plotId!==windowCalc.plotId;n||windowCalc.chunksComplete++;const o=e.target,a=removeWorkerIfNecessary(o);windowCalc.stopped||(!a&&windowCalc.chunksComplete<windowCalc.totalChunks&&assignChunkToWorker(o),n||settleChunkWithCacheAndPublish({data:e.data.v}),windowCalc.chunksComplete>=windowCalc.totalChunks&&(windowCalc.passBlaPixels>0&&(windowCalc.passBlaIterationsSkipped>0?console.log("for entire pass, ["+windowCalc.passBlaPixels.toLocaleString()+"] pixels skipped ["+windowCalc.passBlaIterationsSkipped.toLocaleString()+"] iters with BLA, avgs: ["+Math.floor(windowCalc.passBlaIterationsSkipped/windowCalc.passBlaPixels)+"] per pixel, ["+Math.floor(windowCalc.passBlaIterationsSkipped/windowCalc.passBlaSkips)+"] per skip"):console.log("for entire pass, no pixels had BLA iteration skips")),isImageComplete()?cleanUpWindowCache():calculatePass()))}function settleChunkWithCacheAndPublish(e){let n=windowCalc.minWorkersCount.toString();windowCalc.maxWorkersCount>windowCalc.minWorkersCount&&(n+="-"+windowCalc.maxWorkersCount);const o=cacheComputedPointsInChunk(e.data),a=windowCalc.passCachedPoints;windowCalc.passTotalPoints+=o;const t=buildChunkId(e.data.chunkPos);let i=windowCalc.cacheScannedChunks.get(t);if(void 0!==i){0===e.data.results.length&&(e.data.results=new Array(e.data.chunkLen));for(const n of i)e.data.results[n[0]]=n[1];windowCalc.passCachedPoints+=i.size,windowCalc.cacheScannedChunks.delete(t)}const l=windowCalc.passCachedPoints-a;windowCalc.passTotalPoints+=l,"blaPixelsCount"in e.data&&(windowCalc.passBlaPixels+=e.data.blaPixelsCount,windowCalc.passBlaIterationsSkipped+=e.data.blaIterationsSkipped,windowCalc.passBlaSkips+=e.data.blaSkips);const s={chunks:windowCalc.totalChunks,chunksComplete:windowCalc.chunksComplete,pixelWidth:windowCalc.lineWidth,running:!isImageComplete(),workersCount:n,workersNow:windowCalc.workers.length,passPoints:windowCalc.passTotalPoints,passCachedPoints:windowCalc.passCachedPoints};null!==windowCalc.saCoefficients&&(s.saItersSkipped=windowCalc.saCoefficients.itersToSkip),e.data.calcStatus=s,e.data.chunkPos.x=infNumExpString(e.data.chunkPos.x),e.data.chunkPos.y=infNumExpString(e.data.chunkPos.y),e.data.chunkInc.x=infNumExpString(e.data.chunkInc.x),e.data.chunkInc.y=infNumExpString(e.data.chunkInc.y),self.postMessage(e.data)}function isImageComplete(){return windowCalc.chunksComplete===windowCalc.totalChunks&&windowCalc.lineWidth===windowCalc.finalWidth}function shuffleArray(e){for(let n=e.length-1;n>0;n--){const o=Math.floor(Math.random()*(n+1));[e[n],e[o]]=[e[o],e[n]]}}var calculateWindowPassChunks=function(){if(windowCalc.passBlaPixels=0,windowCalc.passBlaIterationsSkipped=0,windowCalc.passBlaSkips=0,windowCalc.passTotalPoints=0,windowCalc.passCachedPoints=0,windowCalc.chunksComplete=0,windowCalc.xPixelChunks=[],windowCalc.cacheScannedChunks=new Map,windowCalc.cacheScannedChunksCursor=-1,windowCalc.lineWidth===windowCalc.finalWidth)return;const e=Math.round(windowCalc.lineWidth/2);e<=windowCalc.finalWidth?windowCalc.lineWidth=windowCalc.finalWidth:windowCalc.lineWidth=e,sendStatusMessage("Calculating pixels for "+windowCalc.lineWidth+"-wide pass");const n=windowCalc.lineWidth,o=Math.ceil(windowCalc.canvasHeight/n)+1;for(var a=infNumMul(windowCalc.eachPixUnits,infNum(BigInt(n),0n)),t=infNumSub(windowCalc.edges.left,a),i=0;i<windowCalc.canvasWidth;i+=n){t=infNumAdd(t,a);let e={plot:windowCalc.plot,chunkPix:{x:i,y:windowCalc.canvasHeight},chunkPixInc:{x:0,y:-1*n},chunkPos:{x:copyInfNum(t),y:copyInfNum(windowCalc.edges.bottom)},chunkInc:{x:infNum(0n,0n),y:copyInfNum(a)},chunkLen:o,chunkN:windowCalc.n,chunkPrecision:windowCalc.precision,algorithm:windowCalc.algorithm};windowCalc.xPixelChunks.push(e)}shuffleArray(windowCalc.xPixelChunks),windowCalc.totalChunks=windowCalc.xPixelChunks.length};function sendStatusMessage(e){self.postMessage({plotId:windowCalc.plotId,statusMessage:e})}function cleanUpWindowCache(){let e=0,n=0,o=[],a=null,t=null;for(const i of windowCalc.pointsCache)if(a=createInfNumFromFastStr(i[0]),infNumLt(a,windowCalc.edges.left)||infNumGt(a,windowCalc.edges.right))o.push(i[0]),e+=i[1].size;else{let o=[];for(const e of i[1].keys())t=createInfNumFromFastStr(e),infNumLt(t,windowCalc.edges.bottom)||infNumGt(t,windowCalc.edges.top)?o.push(e):n++;for(const e of o)i[1].delete(e);e+=o.length}for(const e of o)windowCalc.pointsCache.delete(e);const i=Math.round(1e4*e/(e+n))/100;console.log("deleted ["+e+"] points from the cache ("+i+"%)")}