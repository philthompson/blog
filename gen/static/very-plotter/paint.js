// as of 2021-10-22, minify with https://minify.js.org/js/ which does NOT require changing "const" to "var" :)
// as of 2021-11-09, minify with https://codebeautify.org/minify-js
const points=[];var totalLength=0;const dCanvas=document.getElementById("dc"),dContext=dCanvas.getContext("2d");var mouseDrag=!1,mouseDragX=0,mouseDragY=0,pinch=!1,pinchStartDist=0,showMousePosition=!1,annotateClickPosition=!0,mouseNoticePosX=infNum(0n,0n),mouseNoticePosY=infNum(0n,0n),shiftPressed=!1,commandPressed=!1,historyParams={},replaceStateTimeout=null,historyTimeout=null,resizeTimeout=null,helpVisible=!1,controlsVisible=!1,menuVisible=!1;const windowLogTiming=!0,forceWorkerReloadUrlParam="force-worker-reload=true",forceWorkerReload=window.location.toString().includes(forceWorkerReloadUrlParam),mandelbrotCircleHeuristic=!1;var precision=24,mandelbrotFloat=!1;const windowCalcIgnorePointColor=-2;var builtGradient=null,workersCount=1;const maxWorkers=32;var useWorkers=!0;function warnAboutWorkers(){document.getElementById("workers-warning").innerHTML="<b><u>Workers do not function in your browser!</u></b><br/><br/>Very Plotter works much better with web workers and subworkers.<br/><br/>Subworkers currently do not function in Safari and some mobile browsers, for example.<br/><br/>The recommended browsers are desktop Firefox, Chrome, or Edge, or similar."}window.Worker||(useWorkers=!1,warnAboutWorkers());const windowCalc={timeout:null,plotName:"",stage:"",lineWidth:0,xPixelChunks:[],resultPoints:[],pointsBounds:"",pointsCache:{},passTimeMs:0,totalTimeMs:0,startTimeMs:0,endTimeMs:0,totalPoints:0,cachedPoints:0,chunksComplete:0,totalChunks:0,eachPixUnits:infNum(1n,0n),leftEdge:infNum(0n,0n),topEdge:infNum(0n,0n),rightEdge:infNum(0n,0n),bottomEdge:infNum(0n,0n),leftEdgeFloat:0,topEdgeFloat:0,n:1,scale:infNum(1n,0n),runtimeMs:-1,avgRuntimeMs:-1,worker:null,workersCountRange:"-",plotId:0,pixelsImage:null};var windowCalcRepeat=-1,windowCalcTimes=[],imageParametersCaption=!1,previewImage=null,previewImageOffsetX=0,previewImageOffsetY=0;const inputGotoTopLeftX=document.getElementById("go-to-tl-x"),inputGotoTopLeftY=document.getElementById("go-to-tl-y"),inputGotoBotRightX=document.getElementById("go-to-br-x"),inputGotoBotRightY=document.getElementById("go-to-br-y"),inputGotoCenterX=document.getElementById("go-to-c-x"),inputGotoCenterY=document.getElementById("go-to-c-y"),inputGotoScale=document.getElementById("go-to-scale"),btnGotoBoundsGo=document.getElementById("go-to-b-go"),btnGotoBoundsReset=document.getElementById("go-to-b-reset"),btnGotoCenterGo=document.getElementById("go-to-c-go"),btnGotoCenterReset=document.getElementById("go-to-c-reset"),inputNIterations=document.getElementById("n-iter-n"),btnNIterationsGo=document.getElementById("n-iter-go"),btnNIterationsReset=document.getElementById("n-iter-reset"),inputGradGrad=document.getElementById("grad-grad"),btnGradGo=document.getElementById("grad-go"),btnGradReset=document.getElementById("grad-reset"),gradCanvas=document.getElementById("gradient-canvas"),gradCanvasRow=document.getElementById("gradient-canvas-tr"),gradCtx=gradCanvas.getContext("2d"),workersSelect=document.getElementById("workers-select"),gradientSelect=document.getElementById("gradient-select"),gradControlsDetails=document.getElementById("gradient-controls-details"),gradError=document.getElementById("gradient-error"),blogLinkMain=document.getElementById("blog-link"),blogLinkMandel=document.getElementById("blog-link-mandel"),inputFields=document.getElementsByTagName("input");function calculateWindowPassChunks(){windowCalc.chunksComplete=0;const e=Math.round(historyParams.lineWidth),t=Math.round(windowCalc.lineWidth/2);windowCalc.lineWidth=t<=e?e:t;const n=Math.round(windowCalc.lineWidth),o=dContext.canvas.width;var a=128;64==n?a=1:32==n?a=4:16==n?a=32:8!=n&&4!=n||(a=64);var r,i=o/a;r=Math.trunc(i/n)+1;for(var s=0,l=[],c=0;c<o;c+=n)++s>r&&(windowCalc.xPixelChunks.push(l),s=1,l=[]),l.push(c);windowCalc.xPixelChunks.push(l),windowCalc.totalChunks=windowCalc.xPixelChunks.length}function computeBoundPointsChunk(e){var t=Date.now();const n=plotsByName[historyParams.plot];var o=[];const a=Math.round(windowCalc.lineWidth),r=createInfNum(a.toString());createInfNum(dContext.canvas.height.toString());let i=null,s=null,l=0;const c=infNumMul(windowCalc.eachPixUnits,r),d=normInfNum(c,windowCalc.topEdge),u=d[0],m=d[1];for(let t=0;t<e.length;t++){l=e[t],xInfNum=infNum(BigInt(e[t]),0n),i=infNumAdd(infNumMul(windowCalc.eachPixUnits,xInfNum),windowCalc.leftEdge),pxStr=infNumFastStr(i)+",",s=m;for(let e=0;e<dCanvas.height;e+=a){const t=pxStr+infNumFastStr(s);if(t in windowCalc.pointsCache)windowCalc.cachedPoints++,windowCalc.pointsCache[t].px.x=l,windowCalc.pointsCache[t].px.y=e,o.push(windowCalc.pointsCache[t]);else{let a={px:getColorPoint(l,e,n.computeBoundPointColor(windowCalc.n,precision,mandelbrotFloat,i,s)),pt:{x:copyInfNum(i),y:copyInfNum(s)}};windowCalc.pointsCache[t]=a,o.push(a)}s=infNumSubNorm(s,u)}}return windowCalc.passTimeMs+=Date.now()-t,windowCalc.totalPoints+=o.length,windowCalc.chunksComplete++,{points:o}}function isPassComputationComplete(){return 0==windowCalc.xPixelChunks.length}function drawCalculatingNoticeOld(e){const t=e.canvas;e.fillStyle="rgba(100,100,100,1.0)";const n=Math.max(24,.03*t.height),o=Math.round(.6*n),a=Math.max(200,18*o);e.fillRect(0,t.height-n,a,n),e.font=o+"px system-ui",e.fillStyle="rgba(0,0,0,0.9)";const r=Math.round(100*windowCalc.chunksComplete/windowCalc.totalChunks);e.fillText("Calculating "+windowCalc.lineWidth+"-wide pixels ("+r+"%) ...",Math.round(.2*n),t.height-Math.round(.2*n))}function cleanUpWindowCache(){let e=0,t=[];for(let n in windowCalc.pointsCache)infNumLt(windowCalc.pointsCache[n].pt.x,windowCalc.leftEdge)||infNumGt(windowCalc.pointsCache[n].pt.x,windowCalc.rightEdge)||infNumLt(windowCalc.pointsCache[n].pt.y,windowCalc.bottomEdge)||infNumGt(windowCalc.pointsCache[n].pt.y,windowCalc.topEdge)?t.push(n):e++;for(let e=0;e<t.length;e++)delete windowCalc.pointsCache[name];const n=Math.round(1e4*t.length/(t.length+e))/100;console.log("deleted ["+t.length+"] points from the cache ("+n+"%)")}const presets=[{plot:"Mandelbrot-set",v:4,n:2e4,lineWidth:1,significantDigits:18,scale:createInfNum("9000000000000"),centerX:createInfNum("-0.74364392705773112"),centerY:createInfNum("0.131825980877688413"),gradient:"bBgwo-B~20.20.20-repeat3",bgColor:"b"},{plot:"Mandelbrot-set",v:4,n:400,lineWidth:1,significantDigits:12,scale:createInfNum("1640000"),centerX:createInfNum("0.273210669156851807493494"),centerY:createInfNum("-0.00588612373984032474800031"),gradient:"rbgyo",bgColor:"b"},{plot:"Primes-1-Step-90-turn",v:4,n:6e4,lineWidth:1,scale:createInfNum("1.35"),centerX:createInfNum("-240"),centerY:createInfNum("288.4"),gradient:"rbgyo",bgColor:"b"},{plot:"Trapped-Knight",v:4,n:2016,lineWidth:1.5,scale:createInfNum("15.0"),centerX:createInfNum("0"),centerY:createInfNum("0"),gradient:"rbgyo",bgColor:"b"},{plot:"Primes-1-Step-45-turn",v:4,n:32400,lineWidth:2,scale:createInfNum("10.95"),centerX:createInfNum("35"),centerY:createInfNum("100"),gradient:"rbgyo",bgColor:"b"}];for(var menuHtml="<div class='plot-desc'><b>Presets:</b>",i=0;i<presets.length;i++)menuHtml+="<button style='float:none; margin:0.5rem; width:2.0rem;' class='preset-view-btn' id='preset-view-btn-"+(i+1)+"'>"+(i+1)+"</button>";menuHtml+="</div>";const plotsByName={};for(i=0;i<plots.length;i++)plotsByName[plots[i].name]=plots[i],menuHtml+="<div class='plot-desc'><button class='plot-view-btn' id='plot-view-btn-"+i+"'>View</button><b>"+plots[i].name+"</b><br/>"+plots[i].desc+"</div>";document.getElementById("menu-contents").innerHTML=menuHtml;const viewButtons=document.getElementsByClassName("plot-view-btn");var activatePlotHandler=function(e){var t=parseInt(e.target.id.split("-")[3]);t>=plots.length&&(t=0);const n=plots[t].name;if(n!=historyParams.plot){var o=Object.assign(historyParams,plots[t].forcedDefaults);o.plot=n,replaceHistoryWithParams(o),parseUrlParams(),start()}};for(i=0;i<viewButtons.length;i++)viewButtons[i].addEventListener("click",activatePlotHandler);function activatePreset(e){replaceHistoryWithParams(e),parseUrlParams(),start()}const presetButtons=document.getElementsByClassName("preset-view-btn");var activatePresetHandler=function(e){var t=parseInt(e.target.id.split("-")[3])-1;(t<0||t>=presets.length)&&(t=0),activatePreset(presets[t])};for(i=0;i<presetButtons.length;i++)presetButtons[i].addEventListener("click",activatePresetHandler);for(let e=1;e<=32;e++)workersSelect.innerHTML+="<option "+(e===workersCount?"selected":"")+' value="'+e+'">'+e+"</option>";function setWorkersCountWithSelect(){workersCount=parseInt(workersSelect.value),changeWorkersCount()}function changeWorkersCount(){null!==windowCalc.worker&&windowCalc.worker.postMessage({t:"workers-count",v:workersCount})}function stopWorkers(){windowCalc.plotId++,null!==windowCalc.worker&&windowCalc.worker.postMessage({t:"stop",v:0})}function changeDirectionDegrees(e,t){for(var n=e+t;n<0;)n+=360;for(;n>=360;)n-=360;return n}function computeNextPointDegrees(e,t,n,o,a={none:""}){return 0==e?getPoint(n+t,o,a):45==e?getPoint(n+t,o+t,a):90==e?getPoint(n,o+t,a):135==e?getPoint(n-t,o+t,a):180==e?getPoint(n-t,o,a):getPoint(225==e?n-t:270==e?n:n+t,o-t,a)}function isPrime(e){if(e<2)return!1;const t=Math.sqrt(e);for(var n=2;n<=t;n++)if(e%n==0)return!1;return!0}function getPoint(e,t,n={none:""}){return{x:e,y:t,v:n}}function getColor(e,t,n){return{r:e,g:t,b:n}}function getColorPoint(e,t,n){return{x:e,y:t,c:n}}function parseUrlParams(){var e=new URLSearchParams(document.location.search);e.has("repeat")&&(windowCalcRepeat=parseInt(e.get("repeat")));var t={plot:"Mandelbrot-set",v:4,lineWidth:1,n:60,scale:infNum(400n,0n),centerX:createInfNum("-0.65"),centerY:infNum(0n,0n),gradient:"Bbgoyw",bgColor:"b"};if(e.has("v")&&["1","2","3","4"].includes(e.get("v"))){let n=t.plot;if(["1","2","3"].includes(e.get("v"))&&e.has("seq")?n=e.get("seq"):["4"].includes(e.get("v"))&&e.has("plot")&&(n=e.get("plot")),n in plotsByName?t.plot=n:alert("no such plot ["+n+"]"),e.has("n")&&(t.n=parseInt(e.get("n").replaceAll(",","")),t.n<0&&(t.n=100)),e.has("scale")&&(t.scale=createInfNum(e.get("scale").replaceAll(",",""))),1==e.get("v"))t.centerX=infNum(0n,0n),t.centerY=infNum(0n,0n);else if(e.has("centerX")&&(t.centerX=createInfNum(e.get("centerX").replaceAll(",",""))),e.has("centerY")){let n=createInfNum(e.get("centerY").replaceAll(",",""));2==e.get("v")&&(n=infNumMul(infNum(-1n,0n),n)),t.centerY=n}if(e.has("lineColor")&&(t.gradient=e.get("lineColor")),e.has("gradient")&&(t.gradient=e.get("gradient")),e.has("bgColor")){const n=e.get("bgColor");n in bgColorSchemes?t.bgColor=n:alert("no such background color scheme ["+n+"]")}if(e.has("lineWidth")&&(t.lineWidth=sanityCheckLineWidth(parseFloat(e.get("lineWidth"))||1,!1,plotsByName[t.plot])),e.has("workers"))try{const t=parseInt(e.get("workers"));t>0&&t<=32&&(workersCount=t,workersSelect.value=workersCount)}catch(e){}}try{buildGradient(t.gradient),hideGradientError()}catch(e){displayGradientError(e)}console.log(t),historyParams=t}function indicateActivePlot(){const e=document.getElementsByClassName("plot-view-btn");for(var t=0;t<e.length;t++)plots[t].name==historyParams.plot?(e[t].innerHTML="Active",e[t].parentNode.classList.add("active-plot")):(e[t].innerHTML="View",e[t].parentNode.classList.remove("active-plot"))}function setupGradientSelectControl(e){const t=[];let n=!1;for(let o=0;o<e.length;o++){let a=!1;e[o].gradient==historyParams.gradient?(a=!0,n=!0):n||o!==e.length-1||(a=!0),t.push("<option "+(a?"selected":"")+' value="'+e[o].gradient+'">'+e[o].name+"</option>")}gradientSelect.innerHTML=t.join(""),updateGradientPreview()}function start(){stopWorkers(),null!=windowCalc.timeout&&window.clearTimeout(windowCalc.timeout),points.length=0;const e=historyParams;if(!e.plot in plotsByName)return void console.log("invalid plot parameter: no such plot ["+e.plot+"]");indicateActivePlot(),e.plot.startsWith("Mandelbrot")?(blogLinkMain.style.display="none",blogLinkMandel.style.display=""):(blogLinkMain.style.display="",blogLinkMandel.style.display="none"),setDScaleVars(dContext);const t=plotsByName[e.plot];if(document.title="Very Plotter - "+t.pageTitle,"sequence"==t.calcFrom){null!=windowCalc.worker&&(windowCalc.worker.terminate(),windowCalc.worker=null),setupGradientSelectControl(sequencePlotGradients);const o=t.computePointsAndLength(t.privContext);totalLength=o.length;for(var n=0;n<o.points.length;n++)points.push(o.points[n]);resetWindowCalcContext(),drawPoints(e)}else"window"==t.calcFrom?(setupGradientSelectControl(windowPlotGradients),resetWindowCalcCache(),resetWindowCalcContext(),calculateAndDrawWindow()):alert('Unexpected "calcFrom" field for the plot: ['+t.calcFrom+"]")}workersSelect.addEventListener("change",setWorkersCountWithSelect),gradientSelect.addEventListener("change",(function(e){if(""!=gradientSelect.value){historyParams.gradient=gradientSelect.value;try{buildGradient(historyParams.gradient),hideGradientError()}catch(e){displayGradientError(e)}redraw()}}));const bgColorSchemes={b:"rgba(0,0,0,1.0)",g:"rgba(51,51,51,1.0)",w:"rgba(255,255,255,1.0)"},bgColorSchemeNames=[];for(let e in bgColorSchemes)bgColorSchemeNames.push(e);function getBgColor(){return historyParams.bgColor in bgColorSchemes?bgColorSchemes[historyParams.bgColor]:"rgba(0,0,0,1.0)"}function fillBg(e){var t=e.canvas;e.fillStyle=getBgColor(),e.fillRect(0,0,t.width,t.height)}function setDScaleVars(e){var t=e.canvas;t.width==t.offsetWidth&&t.height==t.offsetHeight||(t.width=t.offsetWidth,t.height=t.offsetHeight,fillBg(e))}function replaceHistoryWithParams(e){var t=Object.assign({},e);"significantDigits"in t&&(precision=t.significantDigits,delete t.significantDigits),t.scale=infNumExpStringTruncToLen(e.scale,precision),t.centerX=infNumExpStringTruncToLen(e.centerX,precision),t.centerY=infNumExpStringTruncToLen(e.centerY,precision),history.replaceState("",document.title,document.location.pathname+"?"+new URLSearchParams(t).toString()),replaceStateTimeout=null}var replaceHistory=function(){replaceHistoryWithParams(historyParams)},pushToHistory=function(){var e=Object.assign({},historyParams);e.scale=infNumExpStringTruncToLen(historyParams.scale,precision),e.centerX=infNumExpStringTruncToLen(historyParams.centerX,precision),e.centerY=infNumExpStringTruncToLen(historyParams.centerY,precision),history.pushState("",document.title,document.location.pathname+"?"+new URLSearchParams(e).toString()),historyTimeout=null};const windowPlotGradients=[{gradient:"Bbgoyw",name:"dark blue-green"},{gradient:"Bpow-repeat2",name:"purple-orange"},{gradient:"Bw-repeat3",name:"black & white"},{gradient:"GBPw-P~250.34.188-G~73.106.3-repeat2",name:"olive-pink"},{gradient:"TGw-G~250.210.22-T~0.255.195-repeat3",name:"teal-gold"},{gradient:"roywB-B~80.80.255",name:"custom"}],sequencePlotGradients=[{gradient:"rby",name:"red-blue-yellow"},{gradient:"rbgyo",name:"reverse rainbow"},{gradient:"roygbv",name:"rainbow"},{gradient:"br",name:"blue-red"},{gradient:"by",name:"blue-yellow"},{gradient:"op",name:"orange-purple"},{gradient:"LD-L~220.220.220-D~30.30.30",name:"light gray - dark gray"},{gradient:"LD-L~240.20.20-D~100.0.0",name:"red"},{gradient:"LD-L~250.100.0-D~120.60.0",name:"orange"},{gradient:"LD-L~240.240.0-D~120.120.0",name:"yellow"},{gradient:"LD-L~20.240.20-D~0.100.0",name:"green"},{gradient:"LD-L~20.20.250-D~0.0.120",name:"blue"},{gradient:"LD-L~220.0.220-D~120.0.120",name:"purple"},{gradient:"LD-L~90.90.90-D~30.30.30",name:"dark gray"},{gradient:"LD-L~220.220.220-D~100.100.100",name:"light gray"},{gradient:"roywB-B~80.80.255",name:"custom"}],customColorRegex=/^[a-zA-z]~[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$/;function buildGradient(e){try{const t=buildGradientObj(e);builtGradient=t,hideGradientError()}catch(e){displayGradientError(e)}}function buildGradientObj(e){if(0===e.trim().length)throw"gradient must not be empty";const t={r:[240,0,0],o:[240,120,0],y:[240,240,0],g:[0,240,0],b:[0,0,240],v:[240,0,240],p:[240,0,240],w:[255,255,255],B:[0,0,0]},n={},o={},a=e.trim().split("-"),r=a[0],i=["saturation","brightness","width","offset","repeat","mirror","shift"];let s=null;for(let e=1;e<a.length;e++)if(s=a[e].match(customColorRegex),null!==s){let e=s[0].charAt(0),n=s[0].substring(2).split("."),o=[];for(let e=0;e<n.length;e++){let t=parseInt(n[e]);t=Math.min(255,Math.max(0,t)),o.push(t)}t[e]=o}else for(let t=0;t<i.length;t++){const n=i[t];if(a[e].startsWith(n)){o[n]=a[e].substring(n.length);try{if(""==o[n])throw"integer expected as part of option";if(o[n]=parseInt(o[n]),["shift","saturation","brightness"].includes(n)){if(o[n]<-99||o[n]>99)throw"option must be greater than -100 and less than 100"}else if(o[n]<=0||o[n]>100)throw"option must be greater than 0 and less than 101"}catch(t){throw"Invalid integer value for gradient option ["+a[e]+"]: "+t.toString()}}}let l="";for(let e=0;e<r.length&&e<20;e++){const n=r.charAt(e);n in t&&(l+=n)}if(0==l.length&&(l="roygbv"),"mirror"in o&&l.length>1)for(let e=0;e<o.mirror;e++){let e=l.split("");for(let t=e.length-2;t>=0;t--)e.push(e[t]);l=e.join("")}if("repeat"in o&&(l=l.repeat(o.repeat>20?20:o.repeat)),"shift"in o&&l.length>1){let e=l.split("");if(o.shift>0)for(let t=0;t<o.shift;t++)e.unshift(e.pop());else if(o.shift<0)for(let t=0;t>o.shift;t--)e.push(e.shift());l=e.join("")}n.orderedStops=[];const c="width"in o?Math.min(1,o.width/100):1;let d=null;for(let e=0;e<l.length;e++){const o=l.charAt(e);if(!o in t)continue;const a=t[o],r={};null!==d?(r.lower=n.orderedStops[n.orderedStops.length-1].upper,r.rLower=d[0],r.gLower=d[1],r.bLower=d[2],l.length==e+1?r.upper=1:r.upper=r.lower+1/(l.length-1)*c,r.rRange=a[0]-r.rLower,r.gRange=a[1]-r.gLower,r.bRange=a[2]-r.bLower,d=a,n.orderedStops.push(r)):(d=a,r.lower=0,l.length==e+1?(r.upper=c,r.rLower=d[0],r.gLower=d[1],r.bLower=d[2],r.rRange=0,r.gRange=0,r.bRange=0):r.upper=0,n.orderedStops.push(r))}const u=1-c,m="offset"in o?Math.min(u,o.offset/100):0;for(let e=0;e<n.orderedStops.length;e++)m>0&&0===e||(n.orderedStops[e].lower+=m,e+1<n.orderedStops.length&&(n.orderedStops[e].upper+=m),n.orderedStops[e].range=n.orderedStops[e].upper-n.orderedStops[e].lower);return n}function applyBuiltGradient(e,t){const n=Math.max(0,Math.min(1,t));let o="rgba(255,255,255,1.0)";for(let t=0;t<e.orderedStops.length;t++)if(n<=e.orderedStops[t].upper){let a=e.orderedStops[t];if(0==a.range)break;let r=(n-a.lower)/a.range;o="rgba("+(r*a.rRange+a.rLower)+","+(r*a.gRange+a.gLower)+","+(r*a.bRange+a.bLower)+",1.0)";break}return o}function redraw(){resetWindowCalcContext();const e=plotsByName[historyParams.plot];"sequence"==e.calcFrom?(null!=windowCalc.worker&&(windowCalc.worker.terminate(),windowCalc.worker=null),drawPoints(historyParams)):"window"==e.calcFrom&&calculateAndDrawWindow()}function infNumToFloat(e){return parseFloat(infNumToString(e))}function drawPoints(e){null!=replaceStateTimeout&&window.clearTimeout(replaceStateTimeout),replaceStateTimeout=window.setTimeout(replaceHistory,250);const t=e.lineWidth,n=infNumToFloat(e.scale);fillBg(dContext),console.log("drawing ["+points.length+"] points with a total length of ["+totalLength+"]");var o=0,a=totalLength*n,r=(0-windowCalc.leftEdgeFloat)*n,i=(windowCalc.topEdgeFloat-0)*n,s=0,l=0;dContext.lineWidth=t,dContext.lineCap="round",dContext.lineJoin="round";for(var c=0;c<points.length;c++){var d=(points[c].x-windowCalc.leftEdgeFloat)*n,u=(windowCalc.topEdgeFloat-points[c].y)*n;c>0&&(l=u-i,o+=0==(s=d-r)?Math.abs(l):0==l?Math.abs(s):Math.hypot(s,l)),dContext.beginPath(),dContext.moveTo(r,i),dContext.strokeStyle=applyBuiltGradient(builtGradient,o/a),dContext.lineTo(d,u),dContext.stroke(),r=d,i=u}}function resetWindowCalcCache(){console.log("purging window points cache"),null!=windowCalc.worker&&windowCalc.worker.postMessage({t:"wipe-cache",v:null}),windowCalc.pointsCache={}}function resetWindowCalcContext(){null!=windowCalc.timeout&&window.clearTimeout(windowCalc.timeout),fillBg(dContext);const e=historyParams;windowCalc.plotName=e.plot,windowCalc.stage="","adjustPrecision"in plotsByName[e.plot].privContext&&plotsByName[e.plot].privContext.adjustPrecision(historyParams.scale),historyParams.scale=infNumTruncateToLen(historyParams.scale,precision),historyParams.centerX=infNumTruncateToLen(historyParams.centerX,precision),historyParams.centerY=infNumTruncateToLen(historyParams.centerY,precision),null===previewImage&&(previewImage=windowCalc.pixelsImage),windowCalc.lineWidth=128,windowCalc.pixelsImage=dContext.createImageData(dContext.canvas.width,dContext.canvas.height),windowCalc.xPixelChunks=[],windowCalc.resultPoints=[],windowCalc.pointsBounds="",windowCalc.passTimeMs=0,windowCalc.totalTimeMs=0,windowCalc.startTimeMs=Date.now(),windowCalc.endTimeMs=0,windowCalc.totalPoints=0,windowCalc.cachedPoints=0,windowCalc.totalChunks=0,windowCalc.runtimeMs=-1,windowCalc.avgRuntimeMs=-1,windowCalc.workersCountRange="-",windowCalc.plotId++;const t=infNum(2n,0n),n=createInfNum(dContext.canvas.offsetWidth.toString()),o=createInfNum(dContext.canvas.offsetHeight.toString());windowCalc.eachPixUnits=infNumTruncateToLen(infNumDiv(infNum(1n,0n),e.scale),precision);const a=infNumDiv(n,e.scale),r=infNumSub(e.centerX,infNumDiv(infNumDiv(n,t),e.scale)),i=infNumAdd(r,a),s=infNumDiv(o,e.scale),l=infNumAdd(e.centerY,infNumDiv(infNumDiv(o,t),e.scale)),c=infNumSub(l,s);windowCalc.n==e.n&&infNumEq(windowCalc.scale,e.scale)||resetWindowCalcCache(),windowCalc.n=e.n,windowCalc.scale=e.scale,windowCalc.leftEdge=r,windowCalc.topEdge=l,windowCalc.rightEdge=i,windowCalc.bottomEdge=c,windowCalc.leftEdgeFloat=infNumToFloat(r),windowCalc.topEdgeFloat=infNumToFloat(l),resetGoToBoundsValues(),resetGoToCenterValues(),resetNIterationsValue(),resetGradientInput()}function resetGoToBoundsValues(){var e=!1;"usesImaginaryCoordinates"in plotsByName[historyParams.plot].privContext&&(e=plotsByName[historyParams.plot].privContext.usesImaginaryCoordinates),inputGotoTopLeftX.value=windowCalc.leftEdgeFloat,inputGotoTopLeftY.value=windowCalc.topEdgeFloat+(e?"i":""),inputGotoBotRightX.value=infNumToFloat(windowCalc.rightEdge),inputGotoBotRightY.value=infNumToFloat(windowCalc.bottomEdge)+(e?"i":"")}function resetGoToCenterValues(){var e=!1;"usesImaginaryCoordinates"in plotsByName[historyParams.plot].privContext&&(e=plotsByName[historyParams.plot].privContext.usesImaginaryCoordinates),inputGotoCenterX.value=infNumToFloat(historyParams.centerX),inputGotoCenterY.value=infNumToFloat(historyParams.centerY)+(e?"i":""),inputGotoScale.value=infNumExpString(historyParams.scale)}function resetNIterationsValue(){"Mandelbrot-set"===windowCalc.plotName?(document.getElementById("n-iter-label1").innerHTML="iterations",document.getElementById("n-iter-label2").innerHTML="iterations:"):(document.getElementById("n-iter-label1").innerHTML="N",document.getElementById("n-iter-label2").innerHTML="N:"),inputNIterations.value=historyParams.n.toLocaleString()}function applyGoToBoundsValues(){let e,t,n,o;try{e=createInfNum(inputGotoTopLeftX.value.replaceAll(",",""))}catch(e){return void alert("Invalid top left x value")}try{t=createInfNum(inputGotoBotRightX.value.replaceAll(",",""))}catch(e){return void alert("Invalid bottom right x value")}if(infNumGe(e,t))return void alert("Top left x value must be less than bottom right x value");try{n=createInfNum(replaceAllEachChar(inputGotoTopLeftY.value,",iI ",""))}catch(e){return void alert("Invalid top left x value")}try{o=createInfNum(replaceAllEachChar(inputGotoBotRightY.value,",iI ",""))}catch(e){return void alert("Invalid bottom right x value")}if(infNumGe(o,n))return void alert("Bottom left y value must be less than top left y value");const a=infNumSub(t,e),r=infNumSub(n,o),i=infNumAdd(e,infNumDiv(a,infNum(2n,0n))),s=infNumAdd(o,infNumDiv(r,infNum(2n,0n))),l=infNumDiv(createInfNum(dCanvas.width.toString()),a),c=infNumDiv(createInfNum(dCanvas.height.toString()),r);console.log("X spans ["+infNumToString(a)+"] units, thus ["+infNumToString(l)+"] pixels/unit"),console.log("Y spans ["+infNumToString(r)+"] units, thus ["+infNumToString(c)+"] pixels/unit");var d=l;infNumLt(c,l)&&(d=c),console.log("going with scale of ["+infNumToString(d)+"]"),historyParams.centerX=i,historyParams.centerY=s,historyParams.scale=d,redraw()}function applyGoToCenterValues(){try{historyParams.centerX=createInfNum(inputGotoCenterX.value.replaceAll(",",""))}catch(e){return void alert("Invalid center x value")}try{historyParams.centerY=createInfNum(replaceAllEachChar(inputGotoCenterY.value,",iI ",""))}catch(e){return void alert("Invalid center y value")}try{historyParams.scale=createInfNum(inputGotoScale.value.replaceAll(",",""))}catch(e){return void alert("Invalid scale value")}redraw()}function applyNIterationsValue(){const e=parseInt(inputNIterations.value.replaceAll(",",""));e>0&&(historyParams.n=e,resetNIterationsValue(),start())}function textInputHasFocus(){var e=!1;for(let t=0;t<inputFields.length;t++)if(inputFields[t]===document.activeElement){e=!0;break}return e}btnGotoBoundsGo.addEventListener("click",applyGoToBoundsValues),btnGotoBoundsReset.addEventListener("click",resetGoToBoundsValues),btnGotoCenterGo.addEventListener("click",applyGoToCenterValues),btnGotoCenterReset.addEventListener("click",resetGoToCenterValues),btnNIterationsGo.addEventListener("click",applyNIterationsValue),btnNIterationsReset.addEventListener("click",resetNIterationsValue);var calcWorkerOnmessage=function(e){if(!useWorkers)return;if("subworkerNoWorky"in e.data)return useWorkers=!1,warnAboutWorkers(),void redraw();if(e.data.plotId!==windowCalc.plotId)return;drawWorkerColorPoints(e),showMousePosition&&redrawMousePosNotice(),windowCalc.workersCountRange=e.data.calcStatus.workersCount;const t=Math.round(100*e.data.calcStatus.chunksComplete/e.data.calcStatus.chunks);if(t<100)drawCalculatingNotice(dContext,e.data.calcStatus.pixelWidth,t,e.data.calcStatus.workersNow);else{{const t=e.data.calcStatus.passPoints,n=e.data.calcStatus.passCachedPoints,o=Math.round(1e4*n/t)/100;console.log("computing ["+t+"] points of width ["+e.data.calcStatus.pixelWidth+"], of which ["+n+"] were cached ("+o+"%)")}e.data.calcStatus.running?drawStartingPassNotice():(windowLogOverallImage(),windowCalcRepeat>1?(windowCalcRepeat-=1,resetWindowCalcCache(),redraw()):1===windowCalcRepeat&&(windowCalcRepeat-=1,windowAverageTiming()),imageParametersCaption&&drawImageParameters())}};function drawWorkerColorPoints(e){const t=e.data;let n=createInfNumFromExpStr(t.chunkPos.x),o=createInfNumFromExpStr(t.chunkPos.y),a=createInfNumFromExpStr(t.chunkInc.x),r=createInfNumFromExpStr(t.chunkInc.y);const i=t.chunkPixInc.x,s=t.chunkPixInc.y,l=t.calcStatus.pixelWidth;let c=!0;if(infNumEq(infNum(0n,0n),a)&&(c=!1),c){let e=normInfNum(n,a);n=e[0],a=e[1]}else{let e=normInfNum(o,r);o=e[0],r=e[1]}let d=t.chunkPix.x,u=t.chunkPix.y;const m=new Array(t.chunkLen);if(c)for(let e=0;e<t.chunkLen;e++){const r=getColorPoint(d,u,t.results[e]);m[e]={px:r,pt:{x:copyInfNum(n),y:copyInfNum(o)}},d+=i,n=infNumAddNorm(n,a)}else{o=infNumSubNorm(o,r);for(let e=0;e<t.chunkLen;e++){const a=getColorPoint(d,u,t.results[e]);m[e]={px:a,pt:{x:copyInfNum(n),y:copyInfNum(o)}},u+=s,o=infNumAddNorm(o,r)}}drawColorPoints(m,l),previewImage=windowCalc.pixelsImage,previewImageOffsetX=0,previewImageOffsetY=0}function calculateAndDrawWindowSync(e){const t=plotsByName[windowCalc.plotName].computeBoundPointColor;let n=infNumMul(windowCalc.eachPixUnits,infNum(BigInt(e),0n)),o=normInfNum(windowCalc.leftEdge,n),a=o[0],r=o[1];const i=new Array(Math.ceil(dContext.canvas.width/e)*Math.ceil(dContext.canvas.height/e));let s=0;for(let o=0;o<dContext.canvas.width;o+=e){let l=normInfNum(windowCalc.topEdge,n),c=l[0],d=l[1];for(let n=0;n<dContext.canvas.height;n+=e)i[s]={px:getColorPoint(o,n,t(windowCalc.n,precision,mandelbrotFloat,a,c)),pt:{x:copyInfNum(a),y:copyInfNum(c)}},s++,c=infNumSubNorm(c,d);a=infNumAddNorm(a,r)}drawColorPoints(i,e)}function calculateAndDrawWindow(){mandelbrotFloat?(calculateAndDrawWindowSync(64),previewImage=null,previewImageOffsetX=0,previewImageOffsetY=0):drawPreviewImage(),null!=windowCalc.timeout&&window.clearTimeout(windowCalc.timeout),windowCalc.timeout=useWorkers?window.setTimeout(kickoffWindowWorker,250):window.setTimeout(kickoffWindowDrawLoop,250)}function kickoffWindowDrawLoop(){null!=windowCalc.timeout&&window.clearTimeout(windowCalc.timeout),windowCalc.stage=windowCalcStages.calculateChunks,windowCalc.timeout=window.setInterval(windowDrawLoop,5)}function kickoffWindowWorker(){null===windowCalc.worker?(windowCalc.worker=forceWorkerReload?new Worker("calcworker.js?force-worker-reload=true&t="+Date.now()):new Worker("calcworker.js"),windowCalc.worker.onmessage=calcWorkerOnmessage):windowCalc.worker.postMessage({t:"stop",v:0});let e=mandelbrotFloat?32*Math.round(historyParams.lineWidth):128*Math.round(historyParams.lineWidth);for(;e>300;)e/=2;const t={};t.plot=windowCalc.plotName,t.eachPixUnits=windowCalc.eachPixUnits,t.leftEdge=windowCalc.leftEdge,t.rightEdge=windowCalc.rightEdge,t.topEdge=windowCalc.topEdge,t.bottomEdge=windowCalc.bottomEdge,t.n=windowCalc.n,t.precision=precision,t.mandelbrotFloat=mandelbrotFloat,t.startWidth=e,t.finalWidth=Math.round(historyParams.lineWidth),t.canvasWidth=dContext.canvas.width,t.canvasHeight=dContext.canvas.height,t.workers=workersCount,t.plotId=windowCalc.plotId,windowCalc.worker.postMessage({t:"worker-calc",v:t})}var resetGradientInput=function(){inputGradGrad.value=historyParams.gradient,updateGradientPreview()};function updateGradientPreview(){try{const e=buildGradientObj(inputGradGrad.value);hideGradientError(),gradCanvas.width=gradCanvas.offsetWidth,gradCanvas.height=gradCanvas.offsetHeight;const t=gradCanvas.width,n=gradCanvas.height;if(0===t||0===n)return;for(let o=0;o<=t;o++)gradCtx.fillStyle=applyBuiltGradient(e,o/t),gradCtx.fillRect(o-1,0,1,n)}catch(e){displayGradientError(e)}}function displayGradientError(e){gradError.style.display="",gradError.innerHTML=e.toString(),gradCanvasRow.style.display="none"}function hideGradientError(){gradError.innerHTML="",gradError.style.display="none",gradCanvasRow.style.display=""}btnGradGo.addEventListener("click",(function(){try{buildGradient(inputGradGrad.value),historyParams.gradient=inputGradGrad.value,hideGradientError(),sequencePlotGradients[sequencePlotGradients.length-1].gradient=historyParams.gradient,windowPlotGradients[windowPlotGradients.length-1].gradient=historyParams.gradient;setupGradientSelectControl("sequence"==plotsByName[historyParams.plot].calcFrom?sequencePlotGradients:windowPlotGradients),redraw()}catch(e){displayGradientError(e)}})),btnGradReset.addEventListener("click",resetGradientInput),inputGradGrad.addEventListener("change",updateGradientPreview),inputGradGrad.addEventListener("input",updateGradientPreview),inputGradGrad.addEventListener("propertychange",updateGradientPreview),inputGradGrad.addEventListener("paste",updateGradientPreview),gradControlsDetails.addEventListener("toggle",(e=>{gradControlsDetails.open&&updateGradientPreview()}));const windowCalcStages={drawCalculatingNotice:"draw-calculating-notice",calculateChunks:"calculate-chunks",doNextChunk:"next-chunk",cleanUpWindowCache:"clean-up-window-cache",stop:"stop"};function windowDrawLoop(){if(windowCalc.stage===windowCalcStages.drawCalculatingNotice)drawCalculatingNotice(dContext),windowCalc.stage=windowCalcStages.calculateChunks;else if(windowCalc.stage===windowCalcStages.calculateChunks)calculateWindowPassChunks(),windowCalc.stage=windowCalcStages.doNextChunk;else if(windowCalc.stage===windowCalcStages.doNextChunk){if(calculateAndDrawNextChunk()){{windowCalc.totalTimeMs+=windowCalc.passTimeMs;let e=Math.round(1e4*windowCalc.cachedPoints/windowCalc.totalPoints)/100;console.log("computing ["+windowCalc.totalPoints+"] points of width ["+windowCalc.lineWidth+"], of which ["+windowCalc.cachedPoints+"] were cached ("+e+"%), took ["+windowCalc.passTimeMs+"] ms")}windowCalc.lineWidth>Math.round(historyParams.lineWidth)?windowCalc.stage=windowCalcStages.calculateChunks:(windowLogOverallImage(),windowCalcRepeat>1?(windowCalcRepeat-=1,resetWindowCalcCache(),redraw()):1===windowCalcRepeat&&(windowCalcRepeat-=1,windowAverageTiming()),imageParametersCaption&&drawImageParameters(),windowCalc.stage=windowCalcStages.cleanUpWindowCache)}}else windowCalc.stage===windowCalcStages.cleanUpWindowCache?(cleanUpWindowCache(),null!=windowCalc.timeout&&window.clearTimeout(windowCalc.timeout)):null!=windowCalc.timeout&&window.clearTimeout(windowCalc.timeout)}function calculateAndDrawNextChunk(){var e=windowCalc.xPixelChunks.shift();const t=isPassComputationComplete();return e&&(drawColorPoints(computeBoundPointsChunk(e).points,Math.round(windowCalc.lineWidth)),t||drawCalculatingNoticeOld(dContext)),t}function windowLogOverallImage(){windowCalc.endTimeMs=Date.now();const e=windowCalc.endTimeMs-windowCalc.startTimeMs;windowCalc.runtimeMs=e,console.log("COMPLETED image [w:"+dCanvas.width+", h:"+dCanvas.height+", lineWidth:"+Math.round(historyParams.lineWidth)+", n:"+historyParams.n+", centerX:"+infNumToString(infNumTruncateToLen(historyParams.centerX,precision))+", centerY:"+infNumToString(infNumTruncateToLen(historyParams.centerY,precision))+", scale:"+infNumToString(infNumTruncateToLen(historyParams.scale,precision))+"] took: ["+e+"] ms of overall time, ["+windowCalc.totalTimeMs+"] ms of compute/draw time, ["+(e-windowCalc.totalTimeMs)+"] ms of idle/wait time"),windowCalcTimes.push(e)}function windowAverageTiming(){let e=0,t=0;if(windowCalcTimes.length>4)for(let n=0;n<windowCalcTimes.length;n++)windowCalcTimes[n]>e&&(e=windowCalcTimes[n]),(0==t||windowCalcTimes[n]<t)&&(t=windowCalcTimes[n]);let n=0,o=0;for(let a=0;a<windowCalcTimes.length;a++)windowCalcTimes[a]!=e&&windowCalcTimes[a]!=t&&(n+=windowCalcTimes[a],o++);o>0&&(windowCalc.avgRuntimeMs=n/o,console.log("excluding max ["+e+"] and min ["+t+"], the average overall time of ["+o+"] images was ["+windowCalc.avgRuntimeMs+"] ms"))}function drawColorPoints(e,t){null!=replaceStateTimeout&&window.clearTimeout(replaceStateTimeout),replaceStateTimeout=window.setTimeout(replaceHistory,250);const n=dContext.canvas,o=n.width,a=n.height,r=windowCalc.pixelsImage;for(let n=0;n<e.length;n++){const i=e[n].px.x,s=e[n].px.y,l=e[n].px.c;let c=getBgColor();if(-2==l)continue;l>=0&&(c=applyBuiltGradient(builtGradient,l));const d=c.substr(5).split(",");c=getColor(parseInt(d[0]),parseInt(d[1]),parseInt(d[2]));let u=0;for(let e=0;e<t&&!(i+e>=o);e++)for(let n=0;n<t&&!(s+n>=a);n++)u=4*((s+n)*o+(i+e)),r.data[u+0]=c.r,r.data[u+1]=c.g,r.data[u+2]=c.b,r.data[u+3]=255}dContext.putImageData(r,0,0)}function repaintOnly(){"sequence"==plotsByName[historyParams.plot].calcFrom?drawPoints(historyParams):dContext.putImageData(windowCalc.pixelsImage,0,0)}function drawPreviewImage(){null!==previewImage&&dContext.putImageData(previewImage,previewImageOffsetX,previewImageOffsetY)}function drawCalculatingNotice(e,t,n,o){const a=e.canvas;e.fillStyle="rgba(100,100,100,1.0)";const r=Math.max(24,.03*a.height),i=Math.round(.6*r),s=Math.max(200,24*i);e.fillRect(0,a.height-r,s,r),e.font=i+"px system-ui",e.fillStyle="rgba(0,0,0,0.9)";const l=o+" worker"+(o>1?"s":"");e.fillText("Calculating "+t+"-wide pixels ("+n+"%) with "+l+" ...",Math.round(.2*r),a.height-Math.round(.2*r))}function drawStartingPassNotice(){const e=dContext,t=e.canvas;e.fillStyle="rgba(100,100,100,1.0)";const n=Math.max(24,.03*t.height),o=Math.round(.6*n),a=Math.max(200,24*o);e.fillRect(0,t.height-n,a,n),e.font=o+"px system-ui",e.fillStyle="rgba(0,0,0,0.9)",e.fillText("Starting next pass ...",Math.round(.2*n),dCanvas.height-Math.round(.2*n))}function redrawMousePosNotice(){drawMousePosNotice(mouseNoticePosX,mouseNoticePosY)}function drawMousePosNotice(e,t){mouseNoticePosX=e,mouseNoticePosY=t;const n=dCanvas,o=dContext,a=Math.max(16,.03*n.height),r=Math.round(.6*a),i=Math.max(200,18*r),s=[];let l=!1;"usesImaginaryCoordinates"in plotsByName[historyParams.plot].privContext&&(l=plotsByName[historyParams.plot].privContext.usesImaginaryCoordinates);let c=!0;historyParams.plot.startsWith("Mandelbrot")&&!mandelbrotFloat&&(c=!1);let d=null,u=null;c?(d=infNumToFloat(e).toString(),u=infNumToFloat(t).toString()):(d=infNumToString(infNumTruncateToLen(e,precision)),u=infNumToString(infNumTruncateToLen(t,precision)));let m=[["x",d],["y",u+(l?"i":"")]];for(let e=0;e<m.length;e++){const t=m[e][0];let n=m[e][1];for(s.push(t+": "+n.substring(0,22));n.length>22;)n=n.substring(22),s.push("   "+n.substring(0,22))}o.font=r+"px monospace";for(let e=s.length-1,t=0;e>=0;e--,t++)o.fillStyle="rgba(100,100,100,1.0)",o.fillRect(0,n.height-a*(t+2),i,a),o.fillStyle="rgba(0,0,0,0.9)",o.fillText(s[e],Math.round(.2*a),n.height-a*(t+1)-Math.round(.2*a))}function drawImageParameters(){const e=dCanvas,t=dContext,n=Math.max(16,.01*e.height),o=Math.round(.6*n),a=Math.max(200,18*o),r=[];let i=[[" x (re)",infNumExpString(historyParams.centerX)],[" y (im)",infNumExpString(historyParams.centerY)],["  scale",infNumExpString(historyParams.scale)],["   iter",historyParams.n.toString()],["   grad",historyParams.gradient],["  bgclr",historyParams.bgColor],["workers",windowCalc.workersCountRange]];historyParams.plot.startsWith("Mandelbrot")&&mandelbrotFloat?i.push([" precis","floating pt"]):i.push([" precis",precision.toString()]),windowCalc.runtimeMs>0&&i.push([" run ms",windowCalc.runtimeMs.toString()]),windowCalc.avgRuntimeMs>0&&i.push([" avg ms",windowCalc.avgRuntimeMs.toString()]);for(let e=0;e<i.length;e++){const t=i[e][0];let n=i[e][1];for(r.push(t+": "+n.substring(0,20));n.length>20;)n=n.substring(20),r.push("         "+n.substring(0,20))}t.font=o+"px monospace";for(let o=r.length-1,i=0;o>=0;o--,i++)t.fillStyle="rgba(100,100,100,1.0)",t.fillRect(e.width-a,e.height-n*(i+1),a,n),t.fillStyle="rgba(0,0,0,0.9)",t.fillText(r[o],e.width-a+Math.round(.2*n),e.height-n*i-Math.round(.2*n))}function drawSequencePointsData(e,t,n){const o=dCanvas,a=dContext,r=.25*o.width,i=Math.max(16,.03*o.height),s=Math.round(.6*i),l=Math.max(200,18*s),c=[];let d=!0,u=[];for(let t=0;t<e.length;t++){if(d){let n="("+e[t].x+","+e[t].y+")";u.push([n,""]),d=!1}for(let n in e[t].v)u.push(["  "+n,e[t].v[n].toString()])}for(let e=0;e<u.length;e++){const t=u[e][0],n=19-t.length;let o=u[e][1];for(c.push(t+": "+o.substring(0,n));o.length>n;)o=o.substring(n),c.push(new Array(t.length+2).fill(" ").join("")+o.substring(0,n))}a.font=s+"px monospace";for(let e=0;e<c.length;e++)a.fillStyle="rgba(100,100,100,1.0)",a.fillRect(r,i*e,l,i),a.fillStyle="rgba(0,0,0,0.9)",a.fillText(c[e],r+Math.round(.2*i),i*(e+1)-Math.round(.2*i));a.beginPath();const m=infNumToFloat(historyParams.scale),w=(e[0].x-windowCalc.leftEdgeFloat)*m,p=(windowCalc.topEdgeFloat-e[0].y)*m;a.lineWidth=4,a.strokeStyle="rgb(25,25,25)",a.arc(w,p,20,0,2*Math.PI,!1),a.stroke(),a.beginPath(),a.lineWidth=2,a.strokeStyle="rgb(230,230,230)",a.arc(w,p,20,0,2*Math.PI,!1),a.stroke()}function panPercentOfPixels(e,t){const n=e?dCanvas.width:dCanvas.height,o=Math.round(n*t),a=infNumMul(createInfNum(o.toString()),windowCalc.eachPixUnits);e?(historyParams.centerX=infNumAdd(historyParams.centerX,a),previewImageOffsetX-=o):(historyParams.centerY=infNumAdd(historyParams.centerY,a),previewImageOffsetY+=o)}function applyParamPercent(e,t){if(!e in historyParams)return void console.log("unknown params field ["+e+"]");const n=createInfNum(t);if(infNumLe(n,infNum(0n,0n)))return void console.log("cannot apply a zero or negative percentage to field ["+e+"]");const o=infNumMul(historyParams[e],n);historyParams[e]=o}function sanityCheckLineWidth(e,t,n){if("window"==n.calcFrom){let n=Math.round(e);return n>64?t?1:64:n<1?1:n}return e>20?t?.5:20:e<.5?.5:e}function convertPixelPosToPlanePos(e,t){let n=infNum(BigInt(e),0n),o=infNum(BigInt(t),0n);return{x:infNumAdd(infNumDiv(n,historyParams.scale),windowCalc.leftEdge),y:infNumSub(windowCalc.topEdge,infNumDiv(o,historyParams.scale))}}function findClosestSequencePoints(e,t){if(null===points||0===points.length)return[];let n=points[0],o=[n];points.length>1&&n.v.hasOwnProperty("none")&&(n=points[1],o=[n]);let a=Math.pow(n.x-e,2)+Math.pow(n.y-t,2),r=null;for(let i=2;i<points.length;i++)if(r=Math.pow(points[i].x-e,2),r<=a){if(r+=Math.pow(points[i].y-t,2),points[i].v.hasOwnProperty("none"))continue;r<a?(n=points[i],o=[n],a=r):r===a&&o.push(points[i])}return a>Math.pow(dCanvas.width/infNumToFloat(historyParams.scale)*.07,2)?o=[]:o[0].v.hasOwnProperty("none")&&o.shift(),o}function drawAnnotationAtPixelPosition(e,t){if("sequence"==plotsByName[historyParams.plot].calcFrom){let n=convertPixelPosToPlanePos(e,t);const o=findClosestSequencePoints(infNumToFloat(n.x),infNumToFloat(n.y));if(drawPoints(historyParams),0===o.length)return;drawSequencePointsData(o,e,t)}}window.addEventListener("keyup",(function(e){"Shift"==e.key||16==e.keyCode?shiftPressed=!1:"Meta"!=e.key&&224!=e.keyCode&&"Alt"!=e.key&&18!=e.keyCode&&"Control"!=e.key&&17!=e.keyCode||(commandPressed=!1)}));var dispatchCorrespondingKeydownEvent=function(e){let t=e.target.id.substring(4),n=new KeyboardEvent("keydown",{key:t});window.dispatchEvent(n)};const kbdElements=document.getElementsByTagName("kbd");for(let e=0;e<kbdElements.length;e++)kbdElements[e].id.startsWith("kbd-")&&kbdElements[e].addEventListener("click",dispatchCorrespondingKeydownEvent);window.addEventListener("keydown",(function(e){if(!textInputHasFocus())if(16==e.keyCode||"Shift"==e.key)shiftPressed=!0;else if("Meta"==e.key||224==e.keyCode||"Alt"==e.key||18==e.keyCode||"Control"==e.key||17==e.keyCode)commandPressed=!0;else if(39==e.keyCode||"ArrowRight"==e.key)panPercentOfPixels(!0,-.01),redraw();else if(68==e.keyCode||"d"==e.key||"D"==e.key)panPercentOfPixels(!0,-.1),redraw();else if(37==e.keyCode||"ArrowLeft"==e.key)panPercentOfPixels(!0,.01),redraw();else if(65==e.keyCode||"a"==e.key||"A"==e.key)panPercentOfPixels(!0,.1),redraw();else if(38==e.keyCode||"ArrowUp"==e.key)panPercentOfPixels(!1,.01),redraw();else if(87==e.keyCode||"w"==e.key||"W"==e.key)panPercentOfPixels(!1,.1),redraw();else if(40==e.keyCode||"ArrowDown"==e.key)panPercentOfPixels(!1,-.01),redraw();else if(83==e.keyCode||"s"==e.key||"S"==e.key)panPercentOfPixels(!1,-.1),redraw();else if(61==e.keyCode||107==e.keyCode||"+"==e.key)commandPressed||(applyParamPercent("scale","1.01"),redraw());else if(173==e.keyCode||109==e.keyCode||"-"==e.key)commandPressed||(applyParamPercent("scale","0.99"),"minScale"in plotsByName[historyParams.plot].privContext&&infNumLt(historyParams.scale,plotsByName[historyParams.plot].privContext.minScale)?historyParams.scale=plotsByName[historyParams.plot].privContext.minScale:infNumLt(historyParams.scale,infNum(1n,-2n))&&(historyParams.scale=createInfNum("0.01")),redraw());else if(69==e.keyCode||"e"==e.key||"E"==e.key)applyParamPercent("scale","1.05"),redraw();else if(81==e.keyCode||"q"==e.key||"Q"==e.key)applyParamPercent("scale","0.95"),"minScale"in plotsByName[historyParams.plot].privContext&&infNumLt(historyParams.scale,plotsByName[historyParams.plot].privContext.minScale)?historyParams.scale=plotsByName[historyParams.plot].privContext.minScale:infNumLt(historyParams.scale,infNum(1n,-2n))&&(historyParams.scale=createInfNum("0.01")),redraw();else if(67==e.keyCode||"c"==e.key||"C"==e.key)historyParams.centerX=createInfNum("0"),historyParams.centerY=createInfNum("0"),redraw();else if(77==e.keyCode||"m"==e.key||"M"==e.key)"sequence"==plotsByName[historyParams.plot].calcFrom?(historyParams.n+=500,start()):(historyParams.n+=100,start());else if(78==e.keyCode||"n"==e.key||"N"==e.key)historyParams.n>100&&(historyParams.n-=100,start());else if(86==e.keyCode||"v"==e.key||"V"==e.key){const t="sequence"==plotsByName[historyParams.plot].calcFrom?sequencePlotGradients:windowPlotGradients;let n=-1;for(let e=0;e<t.length;e++)if(t[e].gradient==historyParams.gradient){n=e;break}n+=1,n>=t.length&&(n=0),historyParams.gradient=t[n].gradient,setupGradientSelectControl(t);try{buildGradient(historyParams.gradient),hideGradientError()}catch(e){displayGradientError(e)}redraw()}else if(66==e.keyCode||"b"==e.key||"B"==e.key){let e=-1;for(let t=0;t<bgColorSchemeNames.length;t++)if(bgColorSchemeNames[t]==historyParams.bgColor){e=t;break}e+=1,e>=bgColorSchemeNames.length&&(e=0),historyParams.bgColor=bgColorSchemeNames[e],redraw()}else if(88==e.keyCode||"x"==e.key||"X"==e.key){let e=-1;for(let t=0;t<plots.length;t++)if(plots[t].name==historyParams.plot){e=t;break}e+=1,e>=plots.length&&(e=0),historyParams.plot=plots[e].name,replaceHistoryWithParams(Object.assign(historyParams,plots[e].forcedDefaults)),parseUrlParams(),start()}else 90==e.keyCode||"z"==e.key||"Z"==e.key?"window"==plotsByName[historyParams.plot].calcFrom?(historyParams.lineWidth=sanityCheckLineWidth(historyParams.lineWidth+1,!0,plotsByName[historyParams.plot]),start()):(historyParams.lineWidth=sanityCheckLineWidth(historyParams.lineWidth+.5,!0,plotsByName[historyParams.plot]),redraw()):72==e.keyCode||"h"==e.key||"H"==e.key?helpVisible?closeHelpMenu():openHelpMenu():79==e.keyCode||"o"==e.key||"O"==e.key?controlsVisible?closeControlsMenu():openControlsMenu():80==e.keyCode||"p"==e.key||"P"==e.key?menuVisible?closeMenu():openMenu():"r"==e.key||"R"==e.key||82==e.keyCode?(showMousePosition=!showMousePosition)||(repaintOnly(),imageParametersCaption&&drawImageParameters()):"t"==e.key||"T"==e.key||84==e.keyCode?(imageParametersCaption=!imageParametersCaption)?drawImageParameters():repaintOnly():"y"==e.key||"Y"==e.key||89==e.keyCode?(workersCount>1&&workersCount--,workersSelect.value=workersCount,changeWorkersCount()):"u"==e.key||"U"==e.key||85==e.keyCode?(workersCount<32&&workersCount++,workersSelect.value=workersCount,changeWorkersCount()):"."==e.key||190==e.keyCode?(useWorkers||(windowCalc.stage=windowCalcStages.stop),stopWorkers(),repaintOnly()):49==e.keyCode||97==e.keyCode||"1"==e.key?activatePreset(presets[0]):50==e.keyCode||98==e.keyCode||"2"==e.key?activatePreset(presets[1]):51==e.keyCode||99==e.keyCode||"3"==e.key?activatePreset(presets[2]):52==e.keyCode||100==e.keyCode||"4"==e.key?activatePreset(presets[3]):53!=e.keyCode&&101!=e.keyCode&&"5"!=e.key||activatePreset(presets[4])})),window.addEventListener("resize",(function(){null!==resizeTimeout&&window.clearTimeout(resizeTimeout),resizeTimeout=window.setTimeout((function(){setDScaleVars(dContext),redraw()}),500)}));var mouseDownHandler=function(e){if(e.preventDefault(),!("button"in e)||0==e.button){if(shiftPressed){let t=createInfNum(Math.round(e.pageX-dCanvas.width/2).toString()),n=createInfNum(Math.round(dCanvas.height-e.pageY-dCanvas.height/2).toString()),o=infNumAdd(infNumMul(t,windowCalc.eachPixUnits),historyParams.centerX),a=infNumAdd(infNumMul(n,windowCalc.eachPixUnits),historyParams.centerY);return historyParams.centerX=o,historyParams.centerY=a,void redraw()}"touches"in e&&"1"in e.touches&&(pinch=!0,pinchStartDist=Math.hypot(e.touches[0].pageX-e.touches[1].pageX,e.touches[0].pageY-e.touches[1].pageY)),mouseDrag=!0,mouseDragX=e.pageX,mouseDragY=e.pageY}};dCanvas.addEventListener("mousedown",mouseDownHandler),dCanvas.addEventListener("touchstart",mouseDownHandler);var mouseMoveHandler=function(e){if(e.preventDefault(),!mouseDrag){if(showMousePosition){let t=convertPixelPosToPlanePos(e.pageX,e.pageY);drawMousePosNotice(t.x,t.y)}return}const t=e.pageX,n=e.pageY,o=mouseDragX-t,a=mouseDragY-n,r=infNumMul(infNum(BigInt(o),0n),windowCalc.eachPixUnits),i=infNumMul(infNum(BigInt(a),0n),windowCalc.eachPixUnits);if(historyParams.centerX=infNumAdd(historyParams.centerX,r),historyParams.centerY=infNumSub(historyParams.centerY,i),mouseDragX=t,mouseDragY=n,previewImageOffsetX-=o,previewImageOffsetY-=a,"touches"in e&&"1"in e.touches){const t=(e.touches[0].pageX+e.touches[1].pageX)/2,n=(e.touches[0].pageY+e.touches[1].pageY)/2,o=historyParams.scale,a=Math.hypot(e.touches[0].pageX-e.touches[1].pageX,e.touches[0].pageY-e.touches[1].pageY),r=a/pinchStartDist;pinchStartDist=a;const i=infNumMul(historyParams.scale,createInfNum(r.toString())),s=createInfNum("500"),l=createInfNum("0.00005");if("sequence"==plotsByName[historyParams.plot].calcFrom)infNumLt(i,l)?historyParams.scale=l:infNumGt(i,s)?historyParams.scale=s:historyParams.scale=i;else{if("minScale"in plotsByName[historyParams.plot].privContext&&infNumLt(i,plotsByName[historyParams.plot].privContext.minScale))return;historyParams.scale=i}const c=calculateNewZoomCenterX(createInfNum(t.toString()),createInfNum(dCanvas.width.toString()),historyParams.centerX,o,historyParams.scale),d=calculateNewZoomCenterY(createInfNum(n.toString()),createInfNum(dCanvas.height.toString()),historyParams.centerY,o,historyParams.scale);historyParams.centerX=c,historyParams.centerY=d}redraw()};dCanvas.addEventListener("mousemove",mouseMoveHandler),dCanvas.addEventListener("touchmove",mouseMoveHandler);var mouseUpHandler=function(e){e.preventDefault(),mouseDrag=!1,pinch=!1,annotateClickPosition&&drawAnnotationAtPixelPosition(e.pageX,e.pageY)};function calculateNewZoomCenterX(e,t,n,o,a){const r=infNumSub(n,infNumDiv(infNumDiv(t,infNum(2n,0n)),o)),i=infNumAdd(infNumDiv(e,o),r),s=infNumDiv(o,a);return infNumAdd(infNumSub(i,infNumMul(i,s)),infNumMul(n,s))}function calculateNewZoomCenterY(e,t,n,o,a){const r=infNumAdd(n,infNumDiv(infNumDiv(t,infNum(2n,0n)),o)),i=infNumSub(r,infNumDiv(e,o)),s=infNumDiv(o,a);return infNumAdd(infNumSub(infNumMul(n,s),infNumMul(i,s)),i)}function closeMenu(){menuVisible=!1,hideFooter(),document.getElementById("menu").style.display="none",document.getElementById("menu-open-wrap").style.display="block"}function openMenu(){menuVisible=!0,closeHelpMenu(),closeControlsMenu(),showFooter(),document.getElementById("menu").style.display="block",document.getElementById("menu-open-wrap").style.display="none"}function closeHelpMenu(){helpVisible=!1,hideFooter(),document.getElementById("help-menu").style.display="none",document.getElementById("menu-open-wrap").style.display="block"}function openHelpMenu(){closeMenu(),closeControlsMenu(),showFooter(),helpVisible=!0,document.getElementById("help-menu").style.display="block",document.getElementById("menu-open-wrap").style.display="none"}function closeControlsMenu(){controlsVisible=!1,hideFooter(),document.getElementById("controls-menu").style.display="none",document.getElementById("menu-open-wrap").style.display="block"}function openControlsMenu(){closeMenu(),closeHelpMenu(),showFooter(),controlsVisible=!0,document.getElementById("controls-menu").style.display="block",document.getElementById("menu-open-wrap").style.display="none",updateGradientPreview()}function showFooter(){document.getElementById("footer").style.display="block"}function hideFooter(){document.getElementById("footer").style.display="none"}dCanvas.addEventListener("mouseup",mouseUpHandler),dCanvas.addEventListener("touchend",mouseUpHandler),dCanvas.addEventListener("wheel",(function(e){const t=historyParams.scale;var n=createInfNum((1+e.wheelDeltaY/48*.05).toString());infNumLt(n,createInfNum("0"))&&(console.log("NEGATIVE scale factor would have been applied: ["+infNumToString(n)+"]"),n=createInfNum("0.05"));const o=infNumMul(historyParams.scale,n),a=createInfNum("500"),r=createInfNum("0.00005");if("sequence"==plotsByName[historyParams.plot].calcFrom)infNumLt(o,r)?historyParams.scale=r:infNumGt(o,a)?historyParams.scale=a:historyParams.scale=o;else{if("minScale"in plotsByName[historyParams.plot].privContext&&infNumLt(o,plotsByName[historyParams.plot].privContext.minScale))return;historyParams.scale=o}const i=calculateNewZoomCenterX(createInfNum(e.pageX.toString()),createInfNum(dCanvas.width.toString()),historyParams.centerX,t,historyParams.scale),s=calculateNewZoomCenterY(createInfNum(e.pageY.toString()),createInfNum(dCanvas.height.toString()),historyParams.centerY,t,historyParams.scale);historyParams.centerX=i,historyParams.centerY=s,redraw()})),document.getElementById("menu-open").addEventListener("click",(function(e){openMenu()}),!0),document.getElementById("menu-close").addEventListener("click",(function(e){closeMenu(),closeHelpMenu(),closeControlsMenu()}),!0),document.getElementById("help-menu-open").addEventListener("click",(function(e){openHelpMenu()}),!0),document.getElementById("help-menu-close").addEventListener("click",(function(e){closeMenu(),closeHelpMenu(),closeControlsMenu()}),!0),document.getElementById("controls-menu-open").addEventListener("click",(function(e){openControlsMenu()}),!0),document.getElementById("controls-menu-close").addEventListener("click",(function(e){closeMenu(),closeHelpMenu(),closeControlsMenu()}),!0),buildGradient("roygbv"),parseUrlParams(),start();