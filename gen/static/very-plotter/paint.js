// as of 2021-10-22, minify with https://minify.js.org/js/ which does NOT require changing "const" to "var" :)
// as of 2021-11-09, minify with https://codebeautify.org/minify-js
const points=[];var totalLength=0;const dCanvas=document.getElementById("dc"),dContext=dCanvas.getContext("2d");var mouseDrag=!1,mouseDragX=0,mouseDragY=0,pinch=!1,pinchStartDist=0,showMousePosition=!1,annotateClickPosition=!1,mouseNoticePosX=infNum(0n,0n),mouseNoticePosY=infNum(0n,0n),shiftPressed=!1,commandPressed=!1,autoResize=!0,historyParams={},replaceStateTimeout=null,historyTimeout=null,resizeTimeout=null,helpVisible=!1,controlsVisible=!1,menuVisible=!1;const windowLogTiming=!0,forceWorkerReloadUrlParam="force-worker-reload=true",forceWorkerReload=window.location.toString().includes(forceWorkerReloadUrlParam);var precision=24,builtGradient=null,activePlotAlgorithms=null,workersCount=1;const maxWorkers=32;var useWorkers=!0;window.Worker||(useWorkers=!1),useWorkers&&(warnAboutWorkers(),document.getElementById("workers-warning").style.display="none");const appVersion=function(e){let t=document.currentScript.getAttribute("src"),n=new URLSearchParams(t.substring(t.indexOf("?")));return n.has("v")?n.get("v"):"unk"}();function warnAboutWorkers(){document.getElementById("workers-warning").innerHTML="<b><u>Workers do not function in your browser!</u></b><br/><br/>Very Plotter works much better, and can use more advanced algorithms to allow deeper zooming, with web workers and subworkers.<br/><br/>Subworkers currently do not function in Safari and some mobile browsers, for example.<br/><br/>The recommended browsers are desktop Firefox, Chrome, or Edge, or similar."}const windowCalc={timeout:null,plotName:"",algorithm:"auto",stage:"",lineWidth:0,xPixelChunks:[],pixelCache:[],pointsBounds:"",pointsCache:{},passTimeMs:0,totalTimeMs:0,startTimeMs:0,endTimeMs:0,totalPoints:0,cachedPoints:0,chunksComplete:0,totalChunks:0,eachPixUnits:infNum(1n,0n),leftEdge:infNum(0n,0n),topEdge:infNum(0n,0n),rightEdge:infNum(0n,0n),bottomEdge:infNum(0n,0n),leftEdgeFloat:0,topEdgeFloat:0,n:1,scale:infNum(1n,0n),runtimeMs:-1,avgRuntimeMs:-1,worker:null,workersCountRange:"-",saItersSkipped:null,plotId:0,pixelsImage:null,referencePx:null,referencePy:null,referenceOrbit:null};var windowCalcRepeat=-1,windowCalcTimes=[],imageParametersCaption=!1,previewImage=null,previewImageOffsetX=0,previewImageOffsetY=0;const inputGotoTopLeftX=document.getElementById("go-to-tl-x"),inputGotoTopLeftY=document.getElementById("go-to-tl-y"),inputGotoBotRightX=document.getElementById("go-to-br-x"),inputGotoBotRightY=document.getElementById("go-to-br-y"),inputGotoCenterX=document.getElementById("go-to-c-x"),inputGotoCenterY=document.getElementById("go-to-c-y"),inputGotoScale=document.getElementById("go-to-scale"),inputGotoMag=document.getElementById("go-to-mag"),btnGotoBoundsGo=document.getElementById("go-to-b-go"),btnGotoBoundsReset=document.getElementById("go-to-b-reset"),btnGotoCenterGo=document.getElementById("go-to-c-go"),btnGotoCenterReset=document.getElementById("go-to-c-reset"),inputNIterations=document.getElementById("n-iter-n"),btnNIterationsGo=document.getElementById("n-iter-go"),btnNIterationsReset=document.getElementById("n-iter-reset"),inputGradGrad=document.getElementById("grad-grad"),btnGradGo=document.getElementById("grad-go"),btnGradReset=document.getElementById("grad-reset"),gradCanvas=document.getElementById("gradient-canvas"),gradCanvasRow=document.getElementById("gradient-canvas-tr"),gradCtx=gradCanvas.getContext("2d"),workersSelect=document.getElementById("workers-select"),detailsWorkersControls=document.getElementById("workers-controls"),gradientSelect=document.getElementById("gradient-select"),gradControlsDetails=document.getElementById("gradient-controls-details"),gradError=document.getElementById("gradient-error"),autoResizeCb=document.getElementById("auto-resize-cb"),inputAlgoAlgo=document.getElementById("algo-algo"),algoSelect=document.getElementById("algo-select"),btnAlgoGo=document.getElementById("algo-go"),btnAlgoReset=document.getElementById("algo-reset"),detailsAlgoControls=document.getElementById("algo-controls"),blogLinkMain=document.getElementById("blog-link"),blogLinkMandel=document.getElementById("blog-link-mandel"),inputFields=Array.from(document.getElementsByTagName("input")).concat(Array.from(document.getElementsByTagName("textarea")));function isCurrentPlotAWindowPlot(){return"window"==plotsByName[historyParams.plot].calcFrom}function calculateWindowPassChunks(){windowCalc.chunksComplete=0;const e=Math.round(historyParams.lineWidth),t=Math.round(windowCalc.lineWidth/2);windowCalc.lineWidth=t<=e?e:t;const n=Math.round(windowCalc.lineWidth),o=dContext.canvas.width;var a=128;infNumLt(historyParams.scale,createInfNum("1e304"))&&(64==n?a=1:32==n?a=4:16==n?a=32:8!=n&&4!=n||(a=64));var i,r=o/a;i=Math.trunc(r/n)+1;for(var l=0,s=[],c=0;c<o;c+=n)++l>i&&(windowCalc.xPixelChunks.push(s),l=1,s=[]),s.push(c);windowCalc.xPixelChunks.push(s),windowCalc.totalChunks=windowCalc.xPixelChunks.length}function calculateReferenceOrbit(){windowCalc.referencePx=infNumAdd(windowCalc.leftEdge,infNumMul(windowCalc.eachPixUnits,infNum(BigInt(Math.floor(dCanvas.width/2)),0n))),windowCalc.referencePy=infNumAdd(windowCalc.bottomEdge,infNumMul(windowCalc.eachPixUnits,infNum(BigInt(Math.floor(dCanvas.height/2)),0n)));let e=null;for(;null===e||!e.done;)e=plotsByName[historyParams.plot].computeReferenceOrbit(windowCalc.n,precision,windowCalc.algorithm,windowCalc.referencePx,windowCalc.referencePy,e),drawStatusNotice(dContext,e.status);windowCalc.referenceOrbit=e.orbit,console.log("calculated middle reference orbit, with ["+windowCalc.referenceOrbit.length+"] iterations, for point:"),console.log("referencePx: "+infNumToString(windowCalc.referencePx)),console.log("referencePy: "+infNumToString(windowCalc.referencePy))}function computeBoundPointsChunk(e){var t=Date.now();const n=plotsByName[historyParams.plot];var o=[];const a=Math.round(windowCalc.lineWidth),i=createInfNum(a.toString());createInfNum(dContext.canvas.height.toString());let r=null,l=null,s=0;const c=infNumMul(windowCalc.eachPixUnits,i),d=normInfNum(c,windowCalc.topEdge),u=d[0],m=d[1],g=!windowCalc.algorithm.includes("basic");for(let t=0;t<e.length;t++){s=e[t],xInfNum=infNum(BigInt(e[t]),0n),r=infNumAdd(infNumMul(windowCalc.eachPixUnits,xInfNum),windowCalc.leftEdge),pxStr=infNumFastStr(r)+",",l=m;for(let e=0;e<dCanvas.height;e+=a){const t=pxStr+infNumFastStr(l);if(t in windowCalc.pointsCache)windowCalc.cachedPoints++,windowCalc.pointsCache[t].px.x=s,windowCalc.pointsCache[t].px.y=e,o.push(windowCalc.pointsCache[t]);else{let a={px:getColorPoint(s,e,g?n.computeBoundPointColorPerturbOrBla(windowCalc.n,precision,r,l,windowCalc.algorithm,windowCalc.referencePx,windowCalc.referencePy,windowCalc.referenceOrbit,null,null).colorpct:n.computeBoundPointColor(windowCalc.n,precision,windowCalc.algorithm,r,l)),pt:{x:copyInfNum(r),y:copyInfNum(l)}};windowCalc.pointsCache[t]=a,o.push(a)}l=infNumSubNorm(l,u)}}return windowCalc.passTimeMs+=Date.now()-t,windowCalc.totalPoints+=o.length,windowCalc.chunksComplete++,{points:o}}function isPassComputationComplete(){return 0==windowCalc.xPixelChunks.length}function drawCalculatingNoticeOld(e){const t=e.canvas;e.fillStyle="rgba(100,100,100,1.0)";const n=Math.max(24,.03*t.height),o=Math.round(.6*n),a=Math.max(200,18*o);e.fillRect(0,t.height-n,a,n),e.font=o+"px system-ui",e.fillStyle="rgba(0,0,0,0.9)";const i=Math.round(100*windowCalc.chunksComplete/windowCalc.totalChunks);let r="";r=windowCalc.stage===windowCalcStages.drawCalculatingNotice&&windowCalc.algorithm.startsWith("perturb-")?"Calculating reference orbit ...":"Calculating "+windowCalc.lineWidth+"-wide pixels ("+i+"%) ...",e.fillText(r,Math.round(.2*n),t.height-Math.round(.2*n))}function cleanUpWindowCache(){let e=0,t=[];for(let n in windowCalc.pointsCache)infNumLt(windowCalc.pointsCache[n].pt.x,windowCalc.leftEdge)||infNumGt(windowCalc.pointsCache[n].pt.x,windowCalc.rightEdge)||infNumLt(windowCalc.pointsCache[n].pt.y,windowCalc.bottomEdge)||infNumGt(windowCalc.pointsCache[n].pt.y,windowCalc.topEdge)?t.push(n):e++;for(let e=0;e<t.length;e++)delete windowCalc.pointsCache[name];const n=Math.round(1e4*t.length/(t.length+e))/100;console.log("deleted ["+t.length+"] points from the cache ("+n+"%)")}const presets=[{plot:"Mandelbrot-set",v:4,n:2e4,lineWidth:1,mag:createInfNum("2.8e10"),centerX:createInfNum("-0.74364392705773112"),centerY:createInfNum("0.131825980877688413"),gradient:"bBgwo-B~20.20.20-repeat9-shift2",bgColor:"b"},{plot:"Mandelbrot-set",v:4,n:400,lineWidth:1,mag:createInfNum("4.07284768207e3"),centerX:createInfNum("2.73260706888e-1"),centerY:createInfNum("-5.89495392784e-3"),gradient:"roygbv-repeat3",bgColor:"b"},{plot:"Primes-1-Step-90-turn",v:4,n:6e4,lineWidth:1,mag:infNum(1n,0n),centerX:createInfNum("-240"),centerY:createInfNum("288.4"),gradient:"rbgyo",bgColor:"b"},{plot:"Trapped-Knight",v:4,n:2016,lineWidth:1.5,mag:infNum(1n,0n),centerX:createInfNum("0"),centerY:createInfNum("0"),gradient:"rbgyo",bgColor:"b"},{plot:"Primes-1-Step-45-turn",v:4,n:32400,lineWidth:2,mag:createInfNum("1.45033112581e1"),centerX:createInfNum("35"),centerY:createInfNum("100"),gradient:"rbgyo",bgColor:"b"}];for(var menuHtml="<div class='plot-desc'><b>Presets:</b>",i=0;i<presets.length;i++)menuHtml+="<button style='float:none; margin:0.5rem; width:2.0rem;' class='preset-view-btn' id='preset-view-btn-"+(i+1)+"'>"+(i+1)+"</button>";menuHtml+="</div>";const plotsByName={};for(i=0;i<plots.length;i++)plotsByName[plots[i].name]=plots[i],menuHtml+="<div class='plot-desc'><button class='plot-view-btn' id='plot-view-btn-"+i+"'>View</button><b>"+plots[i].name+"</b><br/>"+plots[i].desc+"</div>";document.getElementById("menu-contents").innerHTML=menuHtml;const viewButtons=document.getElementsByClassName("plot-view-btn");var activatePlotHandler=function(e){var t=parseInt(e.target.id.split("-")[3]);t>=plots.length&&(t=0);const n=plots[t].name;if(n!=historyParams.plot){var o=Object.assign(historyParams,plots[t].forcedDefaults);o.plot=n,replaceHistoryWithParams(o),parseUrlParams(),start()}};for(i=0;i<viewButtons.length;i++)viewButtons[i].addEventListener("click",activatePlotHandler);function activatePreset(e){replaceHistoryWithParams(e),parseUrlParams(),start()}const presetButtons=document.getElementsByClassName("preset-view-btn");var activatePresetHandler=function(e){var t=parseInt(e.target.id.split("-")[3])-1;(t<0||t>=presets.length)&&(t=0),activatePreset(presets[t])};for(i=0;i<presetButtons.length;i++)presetButtons[i].addEventListener("click",activatePresetHandler);for(let e=1;e<=32;e++)workersSelect.innerHTML+="<option "+(e===workersCount?"selected":"")+' value="'+e+'">'+e+"</option>";function setWorkersCountWithSelect(){workersCount=parseInt(workersSelect.value),changeWorkersCount()}function changeWorkersCount(){null!==windowCalc.worker&&windowCalc.worker.postMessage({t:"workers-count",v:workersCount})}function stopWorkers(){windowCalc.plotId++,null!==windowCalc.worker&&windowCalc.worker.postMessage({t:"stop",v:0})}function changeDirectionDegrees(e,t){for(var n=e+t;n<0;)n+=360;for(;n>=360;)n-=360;return n}function computeNextPointDegrees(e,t,n,o,a={none:""}){return 0==e?getPoint(n+t,o,a):45==e?getPoint(n+t,o+t,a):90==e?getPoint(n,o+t,a):135==e?getPoint(n-t,o+t,a):180==e?getPoint(n-t,o,a):getPoint(225==e?n-t:270==e?n:n+t,o-t,a)}function isPrime(e){if(e<2)return!1;const t=Math.sqrt(e);for(var n=2;n<=t;n++)if(e%n==0)return!1;return!0}function getPoint(e,t,n={none:""}){return{x:e,y:t,v:n}}function getColor(e,t,n){return{r:e,g:t,b:n}}function getColorPoint(e,t,n){return{x:e,y:t,c:n}}function parseUrlParams(){var e=new URLSearchParams(document.location.search);e.has("repeat")&&(windowCalcRepeat=parseInt(e.get("repeat")));var t={plot:"Mandelbrot-set",algorithm:"auto",v:4,lineWidth:1,n:60,mag:infNum(1n,0n),centerX:createInfNum("-0.65"),centerY:infNum(0n,0n),gradient:"Bbgoyw",bgColor:"b"};if(e.has("v")&&["1","2","3","4"].includes(e.get("v"))){let n=t.plot;["1","2","3"].includes(e.get("v"))&&e.has("seq")?n=e.get("seq"):["4"].includes(e.get("v"))&&e.has("plot")&&(n=e.get("plot")),n in plotsByName?t.plot=n:alert("no such plot ["+n+"]");const o=plotsByName[n];if(e.has("n")&&(t.n=parseInt(e.get("n").replaceAll(",","")),t.n<0&&(t.n=100)),e.has("scale")?(t.scale=parseScaleString(e.get("scale")),t.mag=convertScaleToMagnification(t.scale,o.magnificationFactor)):e.has("mag")&&(t.mag=parseScaleString(e.get("mag")),t.scale=convertMagnificationToScale(t.mag,o.magnificationFactor)),1==e.get("v"))t.centerX=infNum(0n,0n),t.centerY=infNum(0n,0n);else if(e.has("centerX")&&(t.centerX=createInfNum(e.get("centerX").replaceAll(",",""))),e.has("centerY")){let n=createInfNum(e.get("centerY").replaceAll(",",""));2==e.get("v")&&(n=infNumMul(infNum(-1n,0n),n)),t.centerY=n}if(e.has("lineColor")&&(t.gradient=e.get("lineColor")),e.has("gradient")&&(t.gradient=e.get("gradient")),e.has("bgColor")){const n=e.get("bgColor");n in bgColorSchemes?t.bgColor=n:alert("no such background color scheme ["+n+"]")}if(e.has("lineWidth")&&(t.lineWidth=sanityCheckLineWidth(parseFloat(e.get("lineWidth"))||1,!1,o)),e.has("workers"))try{const t=parseInt(e.get("workers"));t>0&&t<=32&&(workersCount=t,workersSelect.value=workersCount)}catch(e){}e.has("algo")&&(t.algorithm=e.get("algo"))}try{buildGradient(t.gradient),hideGradientError()}catch(e){displayGradientError(e)}console.log(t),historyParams=t}function indicateActivePlot(){const e=document.getElementsByClassName("plot-view-btn");for(var t=0;t<e.length;t++)plots[t].name==historyParams.plot?(e[t].innerHTML="Active",e[t].parentNode.classList.add("active-plot")):(e[t].innerHTML="View",e[t].parentNode.classList.remove("active-plot"))}function setupGradientSelectControl(e){const t=[];let n=!1;for(let o=0;o<e.length;o++){let a=!1;e[o].gradient==historyParams.gradient?(a=!0,n=!0):n||o!==e.length-1||(a=!0),t.push("<option "+(a?"selected":"")+' value="'+e[o].gradient+'">'+e[o].name+"</option>")}gradientSelect.innerHTML=t.join(""),updateGradientPreview()}function setupAlgorithmSelectControl(e){const t=[];let n=!1;for(let o=0;o<e.length;o++){let a=!1;e[o].algorithm==historyParams.algorithm?(a=!0,n=!0):n||o!==e.length-1||(a=!0),t.push("<option "+(a?"selected":"")+' value="'+e[o].algorithm+'">'+e[o].name+"</option>")}algoSelect.innerHTML=t.join("")}workersSelect.addEventListener("change",setWorkersCountWithSelect),gradientSelect.addEventListener("change",(function(e){""!=gradientSelect.value&&(inputGradGrad.value=gradientSelect.value,updateGradientPreview())})),algoSelect.addEventListener("change",(function(e){""!=algoSelect.value&&(inputAlgoAlgo.value=algoSelect.value)}));var resetAlgorithmInput=function(){inputAlgoAlgo.value=historyParams.algorithm};function start(){stopWorkers(),null!=windowCalc.timeout&&window.clearTimeout(windowCalc.timeout),points.length=0;const e=historyParams;if(!e.plot in plotsByName)return void console.log("invalid plot parameter: no such plot ["+e.plot+"]");indicateActivePlot(),e.plot.startsWith("Mandelbrot")?(blogLinkMain.style.display="none",blogLinkMandel.style.display="",detailsWorkersControls.style.display="",useWorkers||(document.getElementById("workers-warning").style.display="")):(blogLinkMain.style.display="",blogLinkMandel.style.display="none",detailsWorkersControls.style.display="none",document.getElementById("workers-warning").style.display="none"),setDScaleVars(dContext);const t=plotsByName[e.plot];if(document.title="Very Plotter - "+t.pageTitle,"listAlgorithms"in t.privContext?(setupAlgorithmSelectControl(activePlotAlgorithms=t.privContext.listAlgorithms()),detailsAlgoControls.style.display=""):detailsAlgoControls.style.display="none","sequence"==t.calcFrom){null!=windowCalc.worker&&(windowCalc.worker.terminate(),windowCalc.worker=null),setupGradientSelectControl(sequencePlotGradients);const o=t.computePointsAndLength(t.privContext);totalLength=o.length;for(var n=0;n<o.points.length;n++)points.push(o.points[n]);resetWindowCalcContext(),drawPoints(e)}else"window"==t.calcFrom?(setupGradientSelectControl(windowPlotGradients),resetWindowCalcCache(),resetWindowCalcContext(),calculateAndDrawWindow()):alert('Unexpected "calcFrom" field for the plot: ['+t.calcFrom+"]")}btnAlgoGo.addEventListener("click",(function(){try{historyParams.algorithm=inputAlgoAlgo.value,activePlotAlgorithms[activePlotAlgorithms.length-1].algorithm=historyParams.algorithm,setupAlgorithmSelectControl(activePlotAlgorithms),redraw()}catch(e){}})),btnAlgoReset.addEventListener("click",resetAlgorithmInput);const bgColorSchemes={b:"rgba(0,0,0,1.0)",g:"rgba(51,51,51,1.0)",w:"rgba(255,255,255,1.0)"},bgColorSchemeNames=[];for(let e in bgColorSchemes)bgColorSchemeNames.push(e);function getBgColor(e=!0){let t="rgba(0,0,0,1.0)";if(historyParams.bgColor in bgColorSchemes&&(t=bgColorSchemes[historyParams.bgColor]),e)return t;{let e=getBgColor().substr(5).split(",");return getColor(parseInt(e[0]),parseInt(e[1]),parseInt(e[2]))}}function fillBg(e){var t=e.canvas;e.fillStyle=getBgColor(),e.fillRect(0,0,t.width,t.height)}function setDScaleVarsNoScale(e){var t=e.canvas;t.width==t.offsetWidth&&t.height==t.offsetHeight||(t.width=t.offsetWidth,t.height=t.offsetHeight,fillBg(e))}function setDScaleVars(e){setDScaleVarsNoScale(e),historyParams.scale=convertMagnificationToScale(historyParams.mag,plotsByName[historyParams.plot].magnificationFactor)}function convertScaleToMagnification(e,t){const n=infNum(BigInt(Math.min(dCanvas.width,dCanvas.height)),0n);return infNumDiv(infNumMul(e,t),n,Math.min(precision,24))}function convertScaleToMagnificationIfNeeded(e,t,n){const o=convertScaleToMagnification(e,n);let a=!0;if(null!==t&&"v"in t&&"e"in t){let e=Math.min(precision,24),n=infNumGt(o,t)?infNumDiv(o,t,e):infNumDiv(t,o,e);a=infNumGt(n,createInfNum("1.0001"))}return a?o:t}function convertMagnificationToScale(e,t){const n=infNum(BigInt(Math.min(dCanvas.width,dCanvas.height)),0n);return infNumDiv(infNumMul(e,n),t,Math.min(precision,24))}function replaceHistoryWithParams(e){var t=structuredClone(e);"algorithm"in t&&"auto"!=t.algorithm&&(t.algo=t.algorithm),delete t.algorithm,t.mag=infNumExpStringTruncToLen(e.mag,precision),delete t.scale,t.centerX=infNumExpStringTruncToLen(e.centerX,precision),t.centerY=infNumExpStringTruncToLen(e.centerY,precision),history.replaceState("",document.title,document.location.pathname+"?"+new URLSearchParams(t).toString()),replaceStateTimeout=null}var replaceHistory=function(){replaceHistoryWithParams(historyParams)},pushToHistory=function(){var e=structuredClone(historyParams);e.mag=infNumExpStringTruncToLen(historyParams.mag,precision),delete e.scale,e.centerX=infNumExpStringTruncToLen(historyParams.centerX,precision),e.centerY=infNumExpStringTruncToLen(historyParams.centerY,precision),history.pushState("",document.title,document.location.pathname+"?"+new URLSearchParams(e).toString()),historyTimeout=null};const windowPlotGradients=[{gradient:"Bbgoyw",name:"dark blue-green"},{gradient:"Bpow-repeat2",name:"purple-orange"},{gradient:"Bw-repeat3",name:"black & white"},{gradient:"GBPw-P~250.34.188-G~73.106.3-repeat2",name:"olive-pink"},{gradient:"TGw-G~250.210.22-T~0.255.195-repeat3",name:"teal-gold"},{gradient:"roywB-B~80.80.255",name:"custom"}],sequencePlotGradients=[{gradient:"rby",name:"red-blue-yellow"},{gradient:"rbgyo",name:"reverse rainbow"},{gradient:"roygbv",name:"rainbow"},{gradient:"br",name:"blue-red"},{gradient:"by",name:"blue-yellow"},{gradient:"op",name:"orange-purple"},{gradient:"LD-L~220.220.220-D~30.30.30",name:"light gray - dark gray"},{gradient:"LD-L~240.20.20-D~100.0.0",name:"red"},{gradient:"LD-L~250.100.0-D~120.60.0",name:"orange"},{gradient:"LD-L~240.240.0-D~120.120.0",name:"yellow"},{gradient:"LD-L~20.240.20-D~0.100.0",name:"green"},{gradient:"LD-L~20.20.250-D~0.0.120",name:"blue"},{gradient:"LD-L~220.0.220-D~120.0.120",name:"purple"},{gradient:"LD-L~90.90.90-D~30.30.30",name:"dark gray"},{gradient:"LD-L~220.220.220-D~100.100.100",name:"light gray"},{gradient:"roywB-B~80.80.255",name:"custom"}],customColorRegex=/^[a-zA-z]~[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$/;function buildGradient(e){try{const t=buildGradientObj(e);builtGradient=t,hideGradientError()}catch(e){displayGradientError(e)}}function buildGradientObj(e){if(0===e.trim().length)throw"gradient must not be empty";const t={r:[240,0,0],o:[240,120,0],y:[240,240,0],g:[0,240,0],b:[0,0,240],v:[240,0,240],p:[240,0,240],w:[255,255,255],B:[0,0,0]},n={},o={},a=e.trim().split("-"),i=a[0],r=["saturation","brightness","width","offset","repeat","mirror","shift"];let l=null;for(let e=1;e<a.length;e++)if(l=a[e].match(customColorRegex),null!==l){let e=l[0].charAt(0),n=l[0].substring(2).split("."),o=[];for(let e=0;e<n.length;e++){let t=parseInt(n[e]);t=Math.min(255,Math.max(0,t)),o.push(t)}t[e]=o}else for(let t=0;t<r.length;t++){const n=r[t];if(a[e].startsWith(n)){o[n]=a[e].substring(n.length);try{if(""==o[n])throw"integer expected as part of option";if(o[n]=parseInt(o[n]),["shift","saturation","brightness"].includes(n)){if(o[n]<-99||o[n]>99)throw"option must be greater than -100 and less than 100"}else if(o[n]<=0||o[n]>100)throw"option must be greater than 0 and less than 101"}catch(t){throw"Invalid integer value for gradient option ["+a[e]+"]: "+t.toString()}}}let s="";for(let e=0;e<i.length&&e<20;e++){const n=i.charAt(e);n in t&&(s+=n)}if(0==s.length&&(s="roygbv"),"mirror"in o&&s.length>1){let e=Math.min(o.mirror,4);for(let t=0;t<e;t++){let e=s.split("");for(let t=e.length-2;t>=0;t--)e.push(e[t]);s=e.join("")}}if("repeat"in o&&(s=s.repeat(Math.min(o.repeat,100))),"shift"in o&&s.length>1){let e=s.split("");if(o.shift>0)for(let t=0;t<o.shift;t++)e.unshift(e.pop());else if(o.shift<0)for(let t=0;t>o.shift;t--)e.push(e.shift());s=e.join("")}n.orderedStops=[];const c="width"in o?Math.min(1,o.width/100):1;if(1===s.length){let e=t[s];void 0===e&&(e=t.o),n.orderedStops.push({lower:0,upper:c,rLower:e[0],gLower:e[1],bLower:e[2],rRange:0,gRange:0,bRange:0})}else{let e=0;for(let o=0;o<s.length-1;o++){let a=t[s.charAt(o)];void 0===a&&(a=t.w);let i=t[s.charAt(o+1)];void 0===i&&(i=t.w);const r={};r.rLower=a[0],r.gLower=a[1],r.bLower=a[2],r.rRange=i[0]-r.rLower,r.gRange=i[1]-r.gLower,r.bRange=i[2]-r.bLower,r.lower=e,o==s.length-2?r.upper=1:r.upper=r.lower+1/(s.length-1)*c,n.orderedStops.push(r),e=r.upper}}const d=1-c,u="offset"in o?Math.min(d,o.offset/100):0;for(let e=0;e<n.orderedStops.length;e++)u>0&&0===e||(n.orderedStops[e].lower+=u,e+1<n.orderedStops.length&&(n.orderedStops[e].upper+=u),n.orderedStops[e].range=n.orderedStops[e].upper-n.orderedStops[e].lower);return n}function applyBuiltGradient(e,t,n=!0){let o={r:255,g:255,b:255},a=0,i=e.orderedStops.length-1,r=null;for(;a<=i;)if(r=a+i>>1,t<e.orderedStops[r].lower)i=r-1;else{if(!(t>e.orderedStops[r].upper)){let n=e.orderedStops[r],a=(t-n.lower)/n.range;o={r:Math.floor(a*n.rRange+n.rLower),g:Math.floor(a*n.gRange+n.gLower),b:Math.floor(a*n.bRange+n.bLower)};break}a=r+1}return n?"rgba("+o.r+","+o.g+","+o.b+",1.0)":o}function redraw(){resetWindowCalcContext();const e=plotsByName[historyParams.plot];"sequence"==e.calcFrom?(null!=windowCalc.worker&&(windowCalc.worker.terminate(),windowCalc.worker=null),annotateClickPosition=!0,drawPoints(historyParams)):"window"==e.calcFrom&&(annotateClickPosition=!1,calculateAndDrawWindow())}function infNumToFloat(e){return parseFloat(infNumToString(e))}function drawPoints(e){null!=replaceStateTimeout&&window.clearTimeout(replaceStateTimeout),replaceStateTimeout=window.setTimeout(replaceHistory,250);const t=e.lineWidth,n=infNumToFloat(e.scale);fillBg(dContext),console.log("drawing ["+points.length+"] points with a total length of ["+totalLength+"]");var o=0,a=totalLength*n,i=(0-windowCalc.leftEdgeFloat)*n,r=(windowCalc.topEdgeFloat-0)*n,l=0,s=0;dContext.lineWidth=t,dContext.lineCap="round",dContext.lineJoin="round";for(var c=0;c<points.length;c++){var d=(points[c].x-windowCalc.leftEdgeFloat)*n,u=(windowCalc.topEdgeFloat-points[c].y)*n;c>0&&(s=u-r,o+=0==(l=d-i)?Math.abs(s):0==s?Math.abs(l):Math.hypot(l,s)),dContext.beginPath(),dContext.moveTo(i,r),dContext.strokeStyle=applyBuiltGradient(builtGradient,o/a),dContext.lineTo(d,u),dContext.stroke(),i=d,r=u}}function resetWindowCalcCache(){console.log("purging window points cache"),null!=windowCalc.worker&&windowCalc.worker.postMessage({t:"wipe-cache",v:null}),windowCalc.pointsCache={}}function resetWindowCalcContext(){null!=windowCalc.timeout&&window.clearTimeout(windowCalc.timeout);const e=plotsByName[historyParams.plot],t=historyParams;windowCalc.plotName=t.plot,windowCalc.stage="";let n={precision:12,algorithm:"basic-float"};if("adjustPrecision"in e.privContext&&(n=e.privContext.adjustPrecision(historyParams.scale,useWorkers)),"auto"!=historyParams.algorithm){let e;try{e=parseInt(historyParams.algorithm.split("-").find((e=>e.startsWith("sigdig"))).substring(6))}catch(e){}void 0!==e&&(n.precision=e),n.algorithm=historyParams.algorithm}precision=n.precision,windowCalc.algorithm=n.algorithm,console.log("user-adjusted mandelbrot settings:",{precision:precision,algorithm:windowCalc.algorithm}),historyParams.scale=infNumTruncateToLen(historyParams.scale,precision),historyParams.mag=convertScaleToMagnificationIfNeeded(historyParams.scale,historyParams.mag,e.magnificationFactor),historyParams.centerX=infNumTruncateToLen(historyParams.centerX,precision),historyParams.centerY=infNumTruncateToLen(historyParams.centerY,precision),null===previewImage&&(previewImage=windowCalc.pixelsImage),windowCalc.lineWidth=128,windowCalc.pixelsImage=dContext.getImageData(0,0,dContext.canvas.width,dContext.canvas.height),windowCalc.xPixelChunks=[],windowCalc.pixelCache=new Array(dCanvas.width);for(let e=0;e<windowCalc.pixelCache.length;e++)windowCalc.pixelCache[e]=new Array(dCanvas.height);windowCalc.pointsBounds="",windowCalc.passTimeMs=0,windowCalc.totalTimeMs=0,windowCalc.startTimeMs=Date.now(),windowCalc.endTimeMs=0,windowCalc.totalPoints=0,windowCalc.cachedPoints=0,windowCalc.totalChunks=0,windowCalc.runtimeMs=-1,windowCalc.avgRuntimeMs=-1,windowCalc.workersCountRange="-",windowCalc.saItersSkipped=null,windowCalc.plotId++;const o=infNum(2n,0n),a=createInfNum(dContext.canvas.offsetWidth.toString()),i=createInfNum(dContext.canvas.offsetHeight.toString());windowCalc.eachPixUnits=infNumDiv(infNum(1n,0n),t.scale,precision);const r=infNumDiv(a,t.scale,precision),l=infNumSub(t.centerX,infNumDiv(infNumDiv(a,o,precision),t.scale,precision)),s=infNumAdd(l,r),c=infNumDiv(i,t.scale,precision),d=infNumAdd(t.centerY,infNumDiv(infNumDiv(i,o,precision),t.scale,precision)),u=infNumSub(d,c);windowCalc.n==t.n&&infNumEq(windowCalc.scale,t.scale)||resetWindowCalcCache(),windowCalc.n=t.n,windowCalc.scale=t.scale,windowCalc.leftEdge=l,windowCalc.topEdge=d,windowCalc.rightEdge=s,windowCalc.bottomEdge=u,windowCalc.leftEdgeFloat=infNumToFloat(l),windowCalc.topEdgeFloat=infNumToFloat(d),resetGoToBoundsValues(),resetGoToCenterValues(),resetNIterationsValue(),resetGradientInput(),resetAlgorithmInput()}function resetGoToBoundsValues(){var e=!1;"usesImaginaryCoordinates"in plotsByName[historyParams.plot].privContext&&(e=plotsByName[historyParams.plot].privContext.usesImaginaryCoordinates),inputGotoTopLeftX.value=windowCalc.leftEdgeFloat,inputGotoTopLeftY.value=windowCalc.topEdgeFloat+(e?"i":""),inputGotoBotRightX.value=infNumToFloat(windowCalc.rightEdge),inputGotoBotRightY.value=infNumToFloat(windowCalc.bottomEdge)+(e?"i":"")}function resetGoToCenterValues(){var e=!1;"usesImaginaryCoordinates"in plotsByName[historyParams.plot].privContext&&(e=plotsByName[historyParams.plot].privContext.usesImaginaryCoordinates),inputGotoCenterX.value=infNumExpString(historyParams.centerX),inputGotoCenterY.value=infNumExpString(historyParams.centerY)+(e?"i":""),inputGotoScale.value=infNumExpString(historyParams.scale),inputGotoMag.value=infNumExpString(historyParams.mag)}function resetNIterationsValue(){"Mandelbrot-set"===windowCalc.plotName?(document.getElementById("n-iter-label1").innerHTML="iterations",document.getElementById("n-iter-label2").innerHTML="iterations:"):(document.getElementById("n-iter-label1").innerHTML="N",document.getElementById("n-iter-label2").innerHTML="N:"),inputNIterations.value=historyParams.n.toLocaleString()}function applyGoToBoundsValues(){let e,t,n,o;try{e=createInfNum(inputGotoTopLeftX.value.replaceAll(",",""))}catch(e){return void alert("Invalid top left x value")}try{t=createInfNum(inputGotoBotRightX.value.replaceAll(",",""))}catch(e){return void alert("Invalid bottom right x value")}if(infNumGe(e,t))return void alert("Top left x value must be less than bottom right x value");try{n=createInfNum(replaceAllEachChar(inputGotoTopLeftY.value,",iI ",""))}catch(e){return void alert("Invalid top left x value")}try{o=createInfNum(replaceAllEachChar(inputGotoBotRightY.value,",iI ",""))}catch(e){return void alert("Invalid bottom right x value")}if(infNumGe(o,n))return void alert("Bottom left y value must be less than top left y value");const a=infNumSub(t,e),i=infNumSub(n,o),r=infNumAdd(e,infNumDiv(a,infNum(2n,0n),precision)),l=infNumAdd(o,infNumDiv(i,infNum(2n,0n),precision)),s=infNumDiv(createInfNum(dCanvas.width.toString()),a,precision),c=infNumDiv(createInfNum(dCanvas.height.toString()),i,precision);console.log("X spans ["+infNumToString(a)+"] units, thus ["+infNumToString(s)+"] pixels/unit"),console.log("Y spans ["+infNumToString(i)+"] units, thus ["+infNumToString(c)+"] pixels/unit");var d=s;infNumLt(c,s)&&(d=c),console.log("going with scale of ["+infNumToString(d)+"]"),historyParams.centerX=r,historyParams.centerY=l,historyParams.scale=d,redraw()}function applyGoToCenterValues(){try{historyParams.centerX=createInfNum(inputGotoCenterX.value.replaceAll(",",""))}catch(e){return void alert("Invalid center x value")}try{historyParams.centerY=createInfNum(replaceAllEachChar(inputGotoCenterY.value,",iI ",""))}catch(e){return void alert("Invalid center y value")}try{historyParams.scale=createInfNum(inputGotoScale.value.replaceAll(",",""))}catch(e){return void alert("Invalid scale value")}redraw()}function parseScaleString(e){let t=replaceAllEachChar(e,", +","");if(0===t.length)throw"Value cannot be empty";let n=t.split("^");return n.length>1?infNum(BigInt(n[0].split(".")[0])**BigInt(n[1].replaceAll("-","").split(".")[0]),0n):createInfNum(n[0])}function setMagInputToMatchScale(){if("Invalid magnification value"!=inputGotoScale.value)try{if(0===inputGotoScale.value.length)return;let e=convertScaleToMagnification(parseScaleString(inputGotoScale.value),plotsByName[windowCalc.plotName].magnificationFactor);inputGotoMag.value=infNumExpString(e)}catch(e){inputGotoMag.value="Invalid scale value"}}function setScaleInputToMatchMag(){if("Invalid scale value"!=inputGotoScale.value)try{if(0===inputGotoMag.value.length)return;let e=convertMagnificationToScale(parseScaleString(inputGotoMag.value),plotsByName[windowCalc.plotName].magnificationFactor);inputGotoScale.value=infNumExpString(e)}catch(e){inputGotoScale.value="Invalid magnification value"}}function applyNIterationsValue(){const e=parseInt(inputNIterations.value.replaceAll(",",""));e>0&&(historyParams.n=e,resetNIterationsValue(),start())}function textInputHasFocus(){var e=!1;for(let t=0;t<inputFields.length;t++)if(inputFields[t]===document.activeElement){e=!0;break}return e}inputGotoScale.addEventListener("change",setMagInputToMatchScale),inputGotoScale.addEventListener("input",setMagInputToMatchScale),inputGotoScale.addEventListener("propertychange",setMagInputToMatchScale),inputGotoScale.addEventListener("paste",setMagInputToMatchScale),inputGotoMag.addEventListener("change",setScaleInputToMatchMag),inputGotoMag.addEventListener("input",setScaleInputToMatchMag),inputGotoMag.addEventListener("propertychange",setScaleInputToMatchMag),inputGotoMag.addEventListener("paste",setScaleInputToMatchMag),btnGotoBoundsGo.addEventListener("click",applyGoToBoundsValues),btnGotoBoundsReset.addEventListener("click",resetGoToBoundsValues),btnGotoCenterGo.addEventListener("click",applyGoToCenterValues),btnGotoCenterReset.addEventListener("click",resetGoToCenterValues),btnNIterationsGo.addEventListener("click",applyNIterationsValue),btnNIterationsReset.addEventListener("click",resetNIterationsValue);var calcWorkerOnmessage=function(e){if(!useWorkers)return;if("subworkerNoWorky"in e.data)return useWorkers=!1,warnAboutWorkers(),void redraw();if(e.data.plotId!==windowCalc.plotId)return;if("statusMessage"in e.data){const t=e.data.statusMessage;return repaintOnly(),drawStatusNotice(dContext,t),showMousePosition&&redrawMousePosNotice(),void(imageParametersCaption&&drawImageParameters())}drawWorkerColorPoints(e),showMousePosition&&redrawMousePosNotice(),windowCalc.workersCountRange=e.data.calcStatus.workersCount,"saItersSkipped"in e.data.calcStatus&&(windowCalc.saItersSkipped=e.data.calcStatus.saItersSkipped);const t=Math.round(100*e.data.calcStatus.chunksComplete/e.data.calcStatus.chunks);if(t<100)drawCalculatingNotice(dContext,e.data.calcStatus.pixelWidth,t,e.data.calcStatus.workersNow);else{{const t=e.data.calcStatus.passPoints,n=e.data.calcStatus.passCachedPoints,o=Math.round(1e4*n/t)/100;console.log("computing ["+t+"] points of width ["+e.data.calcStatus.pixelWidth+"], of which ["+n+"] were cached ("+o+"%)")}e.data.calcStatus.running?drawStartingPassNotice():(windowLogOverallImage(),windowCalcRepeat>1?(windowCalcRepeat-=1,resetWindowCalcCache(),redraw()):1===windowCalcRepeat&&(windowCalcRepeat-=1,windowAverageTiming()),imageParametersCaption&&drawImageParameters())}};function drawWorkerColorPoints(e){const t=e.data;let n=createInfNumFromExpStr(t.chunkPos.x),o=createInfNumFromExpStr(t.chunkPos.y),a=createInfNumFromExpStr(t.chunkInc.x),i=createInfNumFromExpStr(t.chunkInc.y);const r=t.chunkPixInc.x,l=t.chunkPixInc.y,s=t.calcStatus.pixelWidth;let c=!0;if(infNumEq(infNum(0n,0n),a)&&(c=!1),c){let e=normInfNum(n,a);n=e[0],a=e[1]}else{let e=normInfNum(o,i);o=e[0],i=e[1]}let d=t.chunkPix.x,u=t.chunkPix.y;const m=new Array(t.chunkLen);if(c)for(let e=0;e<t.chunkLen;e++){const i=getColorPoint(d,u,t.results[e]);m[e]={px:i,pt:{x:copyInfNum(n),y:copyInfNum(o)}},d+=r,n=infNumAddNorm(n,a)}else{o=infNumSubNorm(o,i);for(let e=0;e<t.chunkLen;e++){const a=getColorPoint(d,u,t.results[e]);m[e]={px:a,pt:{x:copyInfNum(n),y:copyInfNum(o)}},u+=l,o=infNumAddNorm(o,i)}}drawColorPoints(m,s),previewImage=windowCalc.pixelsImage,previewImageOffsetX=0,previewImageOffsetY=0}function calculateAndDrawWindowSync(e){const t=plotsByName[windowCalc.plotName].computeBoundPointColor;let n=infNumMul(windowCalc.eachPixUnits,infNum(BigInt(e),0n)),o=normInfNum(windowCalc.leftEdge,n),a=o[0],i=o[1];const r=new Array(Math.ceil(dContext.canvas.width/e)*Math.ceil(dContext.canvas.height/e));let l=0;for(let o=0;o<dContext.canvas.width;o+=e){let s=normInfNum(windowCalc.topEdge,n),c=s[0],d=s[1];for(let n=0;n<dContext.canvas.height;n+=e)r[l]={px:getColorPoint(o,n,t(windowCalc.n,precision,windowCalc.algorithm,a,c)),pt:{x:copyInfNum(a),y:copyInfNum(c)}},l++,c=infNumSubNorm(c,d);a=infNumAddNorm(a,i)}drawColorPoints(r,e)}function calculateAndDrawWindow(){"basic-float"==windowCalc.algorithm?(calculateAndDrawWindowSync(64),previewImage=null,previewImageOffsetX=0,previewImageOffsetY=0):drawPreviewImage(),null!=windowCalc.timeout&&window.clearTimeout(windowCalc.timeout),windowCalc.timeout=useWorkers?window.setTimeout(kickoffWindowWorker,250):window.setTimeout(kickoffWindowDrawLoop,250)}function kickoffWindowDrawLoop(){null!=windowCalc.timeout&&window.clearTimeout(windowCalc.timeout);let e="basic-float"==windowCalc.algorithm?64*Math.round(historyParams.lineWidth):256*Math.round(historyParams.lineWidth);for(;e>300;)e/=2;windowCalc.lineWidth=e,windowCalc.stage=windowCalcStages.drawCalculatingNotice,windowCalc.timeout=window.setInterval(windowDrawLoop,5)}function kickoffWindowWorker(){null===windowCalc.worker?(windowCalc.worker=forceWorkerReload?new Worker("calcworker.js?v="+appVersion+"&"+"force-worker-reload=true&t="+Date.now()):new Worker("calcworker.js?v="+appVersion),windowCalc.worker.onmessage=calcWorkerOnmessage):windowCalc.worker.postMessage({t:"stop",v:0});let e="basic-float"==windowCalc.algorithm?32*Math.round(historyParams.lineWidth):128*Math.round(historyParams.lineWidth);for(;e>300;)e/=2;const t={};t.plot=windowCalc.plotName,t.eachPixUnits=windowCalc.eachPixUnits,t.leftEdge=windowCalc.leftEdge,t.rightEdge=windowCalc.rightEdge,t.topEdge=windowCalc.topEdge,t.bottomEdge=windowCalc.bottomEdge,t.n=windowCalc.n,t.precision=precision,t.algorithm=windowCalc.algorithm,t.startWidth=e,t.finalWidth=Math.round(historyParams.lineWidth),t.canvasWidth=dContext.canvas.width,t.canvasHeight=dContext.canvas.height,t.workers=workersCount,t.plotId=windowCalc.plotId,windowCalc.worker.postMessage({t:"worker-calc",v:t})}var resetGradientInput=function(){inputGradGrad.value=historyParams.gradient,updateGradientPreview()};function updateGradientPreview(){try{const e=buildGradientObj(inputGradGrad.value);hideGradientError(),gradCanvas.width=gradCanvas.offsetWidth,gradCanvas.height=gradCanvas.offsetHeight;const t=gradCanvas.width,n=gradCanvas.height;if(0===t||0===n)return;for(let o=0;o<=t;o++)gradCtx.fillStyle=applyBuiltGradient(e,o/t),gradCtx.fillRect(o-1,0,1,n)}catch(e){displayGradientError(e)}}function displayGradientError(e){gradError.style.display="",gradError.innerHTML=e.toString(),gradCanvasRow.style.display="none"}function hideGradientError(){gradError.innerHTML="",gradError.style.display="none",gradCanvasRow.style.display=""}btnGradGo.addEventListener("click",(function(){try{buildGradient(inputGradGrad.value),historyParams.gradient=inputGradGrad.value,hideGradientError(),isCurrentPlotAWindowPlot()?(windowPlotGradients[windowPlotGradients.length-1].gradient=historyParams.gradient,setupGradientSelectControl(windowPlotGradients),recolor()):(sequencePlotGradients[sequencePlotGradients.length-1].gradient=historyParams.gradient,setupGradientSelectControl(sequencePlotGradients),redraw())}catch(e){displayGradientError(e)}})),btnGradReset.addEventListener("click",resetGradientInput),inputGradGrad.addEventListener("change",updateGradientPreview),inputGradGrad.addEventListener("input",updateGradientPreview),inputGradGrad.addEventListener("propertychange",updateGradientPreview),inputGradGrad.addEventListener("paste",updateGradientPreview),gradControlsDetails.addEventListener("toggle",(function(){gradControlsDetails.open&&updateGradientPreview()})),autoResizeCb.addEventListener("change",(function(){(autoResize=autoResizeCb.checked)&&resizeCanvas()})),autoResizeCb.checked=autoResize;const windowCalcStages={drawCalculatingNotice:"draw-calculating-notice",calculateReferenceOrbit:"calculate-reference-orbit",calculateChunks:"calculate-chunks",doNextChunk:"next-chunk",cleanUpWindowCache:"clean-up-window-cache",stop:"stop"};function windowDrawLoop(){if(windowCalc.stage===windowCalcStages.drawCalculatingNotice)drawCalculatingNoticeOld(dContext),windowCalc.stage=windowCalcStages.calculateReferenceOrbit;else if(windowCalc.stage===windowCalcStages.calculateReferenceOrbit)windowCalc.algorithm.startsWith("perturb-")?calculateReferenceOrbit():(windowCalc.referencePx=null,windowCalc.referencePy=null,windowCalc.referenceOrbit=null),windowCalc.stage=windowCalcStages.calculateChunks;else if(windowCalc.stage===windowCalcStages.calculateChunks)calculateWindowPassChunks(),windowCalc.stage=windowCalcStages.doNextChunk;else if(windowCalc.stage===windowCalcStages.doNextChunk){if(calculateAndDrawNextChunk()){{windowCalc.totalTimeMs+=windowCalc.passTimeMs;let e=Math.round(1e4*windowCalc.cachedPoints/windowCalc.totalPoints)/100;console.log("computing ["+windowCalc.totalPoints+"] points of width ["+windowCalc.lineWidth+"], of which ["+windowCalc.cachedPoints+"] were cached ("+e+"%), took ["+windowCalc.passTimeMs+"] ms")}windowCalc.lineWidth>Math.round(historyParams.lineWidth)?windowCalc.stage=windowCalcStages.calculateChunks:(windowLogOverallImage(),windowCalcRepeat>1?(windowCalcRepeat-=1,resetWindowCalcCache(),redraw()):1===windowCalcRepeat&&(windowCalcRepeat-=1,windowAverageTiming()),imageParametersCaption&&drawImageParameters(),windowCalc.stage=windowCalcStages.cleanUpWindowCache)}}else windowCalc.stage===windowCalcStages.cleanUpWindowCache?(cleanUpWindowCache(),null!=windowCalc.timeout&&window.clearTimeout(windowCalc.timeout)):null!=windowCalc.timeout&&window.clearTimeout(windowCalc.timeout)}function calculateAndDrawNextChunk(){var e=windowCalc.xPixelChunks.shift();const t=isPassComputationComplete();return e&&(drawColorPoints(computeBoundPointsChunk(e).points,Math.round(windowCalc.lineWidth)),previewImage=windowCalc.pixelsImage,previewImageOffsetX=0,previewImageOffsetY=0,t||drawCalculatingNoticeOld(dContext)),t}function windowLogOverallImage(){windowCalc.endTimeMs=Date.now();const e=windowCalc.endTimeMs-windowCalc.startTimeMs;windowCalc.runtimeMs=e,console.log("COMPLETED image [w:"+dCanvas.width+", h:"+dCanvas.height+", lineWidth:"+Math.round(historyParams.lineWidth)+", n:"+historyParams.n+", centerX:"+infNumToString(infNumTruncateToLen(historyParams.centerX,precision))+", centerY:"+infNumToString(infNumTruncateToLen(historyParams.centerY,precision))+", scale:"+infNumToString(infNumTruncateToLen(historyParams.scale,precision))+"] took: ["+e+"] ms of overall time, ["+windowCalc.totalTimeMs+"] ms of compute/draw time, ["+(e-windowCalc.totalTimeMs)+"] ms of idle/wait time"),windowCalcTimes.push(e)}function windowAverageTiming(){let e=0,t=0;if(windowCalcTimes.length>4)for(let n=0;n<windowCalcTimes.length;n++)windowCalcTimes[n]>e&&(e=windowCalcTimes[n]),(0==t||windowCalcTimes[n]<t)&&(t=windowCalcTimes[n]);let n=0,o=0;for(let a=0;a<windowCalcTimes.length;a++)windowCalcTimes[a]!=e&&windowCalcTimes[a]!=t&&(n+=windowCalcTimes[a],o++);o>0&&(windowCalc.avgRuntimeMs=n/o,console.log("excluding max ["+e+"] and min ["+t+"], the average overall time of ["+o+"] images was ["+windowCalc.avgRuntimeMs+"] ms"))}function drawColorPoints(e,t){null!=replaceStateTimeout&&window.clearTimeout(replaceStateTimeout),replaceStateTimeout=window.setTimeout(replaceHistory,250);const n=dContext.canvas,o=n.width,a=n.height,i=windowCalc.pixelsImage,r=getBgColor(!1);let l=null;for(let n=0;n<e.length;n++){const s=e[n].px.x,c=e[n].px.y,d=e[n].px.c;if(d==windowCalcIgnorePointColor)continue;l=d==windowCalcBackgroundColor?r:applyBuiltGradient(builtGradient,d,!1);let u=0;for(let e=0;e<t&&!(s+e>=o);e++)for(let n=0;n<t&&!(c+n>=a);n++)u=4*((c+n)*o+(s+e)),i.data[u+0]=l.r,i.data[u+1]=l.g,i.data[u+2]=l.b,i.data[u+3]=255,windowCalc.pixelCache[s+e][c+n]=d}dContext.putImageData(i,0,0)}function recolor(){null!=replaceStateTimeout&&window.clearTimeout(replaceStateTimeout),replaceStateTimeout=window.setTimeout(replaceHistory,250),resetGradientInput();const e=dCanvas.width,t=dCanvas.height,n=getBgColor(!1);let o=-2,a=null,i=null;for(let r=0;r<e;r++)for(let l=0;l<t;l++)o=windowCalc.pixelCache[r][l],void 0!==o&&o!=windowCalcIgnorePointColor&&(a=o==windowCalcBackgroundColor?n:applyBuiltGradient(builtGradient,o,!1),i=4*(l*e+r),windowCalc.pixelsImage.data[i+0]=a.r,windowCalc.pixelsImage.data[i+1]=a.g,windowCalc.pixelsImage.data[i+2]=a.b,windowCalc.pixelsImage.data[i+3]=255);dContext.putImageData(windowCalc.pixelsImage,0,0)}function repaintOnly(){"sequence"==plotsByName[historyParams.plot].calcFrom?drawPoints(historyParams):dContext.putImageData(windowCalc.pixelsImage,0,0)}function drawPreviewImage(){fillBg(dContext),null!==previewImage&&dContext.putImageData(previewImage,previewImageOffsetX,previewImageOffsetY)}function drawCalculatingNotice(e,t,n,o){const a=e.canvas;e.fillStyle="rgba(100,100,100,1.0)";const i=Math.max(24,.03*a.height),r=Math.round(.6*i),l=Math.max(200,24*r);e.fillRect(0,a.height-i,l,i),e.font=r+"px system-ui",e.fillStyle="rgba(0,0,0,0.9)";const s=o+" worker"+(o>1?"s":"");e.fillText("Calculating "+t+"-wide pixels ("+n+"%) with "+s+" ...",Math.round(.2*i),a.height-Math.round(.2*i))}function drawStatusNotice(e,t){const n=e.canvas;e.fillStyle="rgba(100,100,100,1.0)";const o=Math.max(24,.03*n.height),a=Math.round(.6*o),i=Math.max(200,24*a);e.fillRect(0,n.height-o,i,o),e.font=a+"px system-ui",e.fillStyle="rgba(0,0,0,0.9)",e.fillText(t+" ...",Math.round(.2*o),n.height-Math.round(.2*o))}function drawStartingPassNotice(){const e=dContext,t=e.canvas;e.fillStyle="rgba(100,100,100,1.0)";const n=Math.max(24,.03*t.height),o=Math.round(.6*n),a=Math.max(200,24*o);e.fillRect(0,t.height-n,a,n),e.font=o+"px system-ui",e.fillStyle="rgba(0,0,0,0.9)",e.fillText("Starting next pass ...",Math.round(.2*n),dCanvas.height-Math.round(.2*n))}function redrawMousePosNotice(){drawMousePosNotice(mouseNoticePosX,mouseNoticePosY)}function drawMousePosNotice(e,t){mouseNoticePosX=e,mouseNoticePosY=t;const n=dCanvas,o=dContext,a=Math.max(16,.03*n.height),i=Math.round(.6*a),r=Math.max(200,18*i),l=[];let s=!1;"usesImaginaryCoordinates"in plotsByName[historyParams.plot].privContext&&(s=plotsByName[historyParams.plot].privContext.usesImaginaryCoordinates);let c=!0;historyParams.plot.startsWith("Mandelbrot")&&"basic-float"!=windowCalc.algorithm&&(c=!1);let d=null,u=null;c?(d=infNumToFloat(e).toString(),u=infNumToFloat(t).toString()):(d=infNumToString(infNumTruncateToLen(e,precision)),u=infNumToString(infNumTruncateToLen(t,precision)));let m=[["x",d],["y",u+(s?"i":"")]];for(let e=0;e<m.length;e++){const t=m[e][0];let n=m[e][1];for(l.push(t+": "+n.substring(0,22));n.length>22;)n=n.substring(22),l.push("   "+n.substring(0,22))}o.font=i+"px monospace";for(let e=l.length-1,t=0;e>=0;e--,t++)o.fillStyle="rgba(100,100,100,1.0)",o.fillRect(0,n.height-a*(t+2),r,a),o.fillStyle="rgba(0,0,0,0.9)",o.fillText(l[e],Math.round(.2*a),n.height-a*(t+1)-Math.round(.2*a))}function drawImageParameters(){const e=dCanvas,t=dContext,n=Math.max(16,.01*e.height),o=Math.round(.6*n),a=Math.max(200,26*o*.9),i=[];let r=[[" x (re)",infNumExpString(historyParams.centerX)],[" y (im)",infNumExpString(historyParams.centerY)],[" magnif",infNumExpString(historyParams.mag)],["  scale",infNumExpString(historyParams.scale)],["   iter",historyParams.n.toString()],["   grad",historyParams.gradient],["  bgclr",historyParams.bgColor],["workers",windowCalc.workersCountRange]];r.push(["   algo",windowCalc.algorithm]),r.push(["sig dig",precision.toString()]),null!==windowCalc.saItersSkipped&&r.push(["sa skip",windowCalc.saItersSkipped.toString()]),windowCalc.runtimeMs>0&&r.push([" run ms",windowCalc.runtimeMs.toString()]),windowCalc.avgRuntimeMs>0&&r.push([" avg ms",windowCalc.avgRuntimeMs.toString()]);for(let e=0;e<r.length;e++){const t=r[e][0];let n=r[e][1];for(i.push(t+": "+n.substring(0,26));n.length>26;)n=n.substring(26),i.push("         "+n.substring(0,26))}t.font=o+"px monospace";for(let o=i.length-1,r=0;o>=0;o--,r++)t.fillStyle="rgba(100,100,100,1.0)",t.fillRect(e.width-a,e.height-n*(r+1),a,n),t.fillStyle="rgba(0,0,0,0.9)",t.fillText(i[o],e.width-a+Math.round(.2*n),e.height-n*r-Math.round(.2*n))}function drawSequencePointsData(e,t,n){const o=dCanvas,a=dContext,i=.25*o.width,r=Math.max(16,.03*o.height),l=Math.round(.6*r),s=Math.max(200,18*l),c=[];let d=!0,u=[];for(let t=0;t<e.length;t++){if(d){let n="("+e[t].x+","+e[t].y+")";u.push([n,""]),d=!1}for(let n in e[t].v)u.push(["  "+n,e[t].v[n].toString()])}for(let e=0;e<u.length;e++){const t=u[e][0],n=19-t.length;let o=u[e][1];for(c.push(t+": "+o.substring(0,n));o.length>n;)o=o.substring(n),c.push(new Array(t.length+2).fill(" ").join("")+o.substring(0,n))}a.font=l+"px monospace";for(let e=0;e<c.length;e++)a.fillStyle="rgba(100,100,100,1.0)",a.fillRect(i,r*e,s,r),a.fillStyle="rgba(0,0,0,0.9)",a.fillText(c[e],i+Math.round(.2*r),r*(e+1)-Math.round(.2*r));a.beginPath();const m=infNumToFloat(historyParams.scale),g=(e[0].x-windowCalc.leftEdgeFloat)*m,w=(windowCalc.topEdgeFloat-e[0].y)*m;a.lineWidth=4,a.strokeStyle="rgb(25,25,25)",a.arc(g,w,20,0,2*Math.PI,!1),a.stroke(),a.beginPath(),a.lineWidth=2,a.strokeStyle="rgb(230,230,230)",a.arc(g,w,20,0,2*Math.PI,!1),a.stroke()}function panPercentOfPixels(e,t){const n=e?dCanvas.width:dCanvas.height,o=Math.round(n*t),a=infNumMul(createInfNum(o.toString()),windowCalc.eachPixUnits);e?(historyParams.centerX=infNumAdd(historyParams.centerX,a),previewImageOffsetX-=o):(historyParams.centerY=infNumAdd(historyParams.centerY,a),previewImageOffsetY+=o)}function applyParamPercent(e,t){if(!e in historyParams)return void console.log("unknown params field ["+e+"]");const n=createInfNum(t);if(infNumLe(n,infNum(0n,0n)))return void console.log("cannot apply a zero or negative percentage to field ["+e+"]");const o=infNumMul(historyParams[e],n);historyParams[e]=o}function sanityCheckLineWidth(e,t,n){if("window"==n.calcFrom){let n=Math.round(e);return n>64?t?1:64:n<1?1:n}return e>20?t?.5:20:e<.5?.5:e}function convertPixelPosToPlanePos(e,t){let n=infNum(BigInt(e),0n),o=infNum(BigInt(t),0n);return{x:infNumAdd(infNumDiv(n,historyParams.scale,precision),windowCalc.leftEdge),y:infNumSub(windowCalc.topEdge,infNumDiv(o,historyParams.scale,precision))}}function findClosestSequencePoints(e,t){if(null===points||0===points.length)return[];let n=points[0],o=[n];points.length>1&&n.v.hasOwnProperty("none")&&(n=points[1],o=[n]);let a=Math.pow(n.x-e,2)+Math.pow(n.y-t,2),i=null;for(let r=2;r<points.length;r++)if(i=Math.pow(points[r].x-e,2),i<=a){if(i+=Math.pow(points[r].y-t,2),points[r].v.hasOwnProperty("none"))continue;i<a?(n=points[r],o=[n],a=i):i===a&&o.push(points[r])}return a>Math.pow(dCanvas.width/infNumToFloat(historyParams.scale)*.07,2)?o=[]:o[0].v.hasOwnProperty("none")&&o.shift(),o}function drawAnnotationAtPixelPosition(e,t){if("sequence"==plotsByName[historyParams.plot].calcFrom){let n=convertPixelPosToPlanePos(e,t);const o=findClosestSequencePoints(infNumToFloat(n.x),infNumToFloat(n.y));if(drawPoints(historyParams),0===o.length)return;drawSequencePointsData(o,e,t)}}window.addEventListener("keyup",(function(e){"Shift"==e.key||16==e.keyCode?shiftPressed=!1:"Meta"!=e.key&&224!=e.keyCode&&"Alt"!=e.key&&18!=e.keyCode&&"Control"!=e.key&&17!=e.keyCode||(commandPressed=!1)}));var dispatchCorrespondingKeydownEvent=function(e){let t=e.target.id.substring(4),n=new KeyboardEvent("keydown",{key:t});window.dispatchEvent(n)};const kbdElements=document.getElementsByTagName("kbd");for(let e=0;e<kbdElements.length;e++)kbdElements[e].id.startsWith("kbd-")&&kbdElements[e].addEventListener("click",dispatchCorrespondingKeydownEvent);function resizeCanvas(){autoResize&&(setDScaleVars(dContext),redraw())}window.addEventListener("keydown",(function(e){if(!textInputHasFocus())if(16==e.keyCode||"Shift"==e.key)shiftPressed=!0;else if("Meta"==e.key||224==e.keyCode||"Alt"==e.key||18==e.keyCode||"Control"==e.key||17==e.keyCode)commandPressed=!0;else if(39==e.keyCode||"ArrowRight"==e.key)panPercentOfPixels(!0,-.01),redraw();else if(68==e.keyCode||"d"==e.key||"D"==e.key)panPercentOfPixels(!0,-.1),redraw();else if(37==e.keyCode||"ArrowLeft"==e.key)panPercentOfPixels(!0,.01),redraw();else if(65==e.keyCode||"a"==e.key||"A"==e.key)panPercentOfPixels(!0,.1),redraw();else if(38==e.keyCode||"ArrowUp"==e.key)panPercentOfPixels(!1,.01),redraw();else if(87==e.keyCode||"w"==e.key||"W"==e.key)panPercentOfPixels(!1,.1),redraw();else if(40==e.keyCode||"ArrowDown"==e.key)panPercentOfPixels(!1,-.01),redraw();else if(83==e.keyCode||"s"==e.key||"S"==e.key)panPercentOfPixels(!1,-.1),redraw();else if(61==e.keyCode||107==e.keyCode||"+"==e.key)commandPressed||(applyParamPercent("scale","1.01"),redraw());else if(173==e.keyCode||109==e.keyCode||"-"==e.key)commandPressed||(applyParamPercent("scale","0.99"),"minScale"in plotsByName[historyParams.plot].privContext&&infNumLt(historyParams.scale,plotsByName[historyParams.plot].privContext.minScale)?historyParams.scale=plotsByName[historyParams.plot].privContext.minScale:infNumLt(historyParams.scale,infNum(1n,-2n))&&(historyParams.scale=createInfNum("0.01")),redraw());else if(69==e.keyCode||"e"==e.key||"E"==e.key)"sequence"==plotsByName[historyParams.plot].calcFrom?applyParamPercent("scale","1.05"):applyParamPercent("scale","10"),redraw();else if(81==e.keyCode||"q"==e.key||"Q"==e.key)"sequence"==plotsByName[historyParams.plot].calcFrom?applyParamPercent("scale","0.95"):applyParamPercent("scale","0.1"),"minScale"in plotsByName[historyParams.plot].privContext&&infNumLt(historyParams.scale,plotsByName[historyParams.plot].privContext.minScale)?historyParams.scale=plotsByName[historyParams.plot].privContext.minScale:infNumLt(historyParams.scale,infNum(1n,-2n))&&(historyParams.scale=createInfNum("0.01")),redraw();else if(67==e.keyCode||"c"==e.key||"C"==e.key)historyParams.centerX=createInfNum("0"),historyParams.centerY=createInfNum("0"),redraw();else if(77==e.keyCode||"m"==e.key||"M"==e.key)"sequence"==plotsByName[historyParams.plot].calcFrom?(historyParams.n+=500,start()):(historyParams.n+=100,start());else if(78==e.keyCode||"n"==e.key||"N"==e.key)historyParams.n>100&&(historyParams.n-=100,start());else if(86==e.keyCode||"v"==e.key||"V"==e.key){const t="sequence"==plotsByName[historyParams.plot].calcFrom?sequencePlotGradients:windowPlotGradients;let n=-1;for(let e=0;e<t.length;e++)if(t[e].gradient==historyParams.gradient){n=e;break}n+=1,n>=t.length&&(n=0),historyParams.gradient=t[n].gradient,setupGradientSelectControl(t);try{buildGradient(historyParams.gradient),hideGradientError()}catch(e){displayGradientError(e)}"window"==plotsByName[historyParams.plot].calcFrom?recolor():redraw()}else if(66==e.keyCode||"b"==e.key||"B"==e.key){let e=-1;for(let t=0;t<bgColorSchemeNames.length;t++)if(bgColorSchemeNames[t]==historyParams.bgColor){e=t;break}e+=1,e>=bgColorSchemeNames.length&&(e=0),historyParams.bgColor=bgColorSchemeNames[e],"window"==plotsByName[historyParams.plot].calcFrom?recolor():redraw()}else if(88==e.keyCode||"x"==e.key||"X"==e.key){let e=-1;for(let t=0;t<plots.length;t++)if(plots[t].name==historyParams.plot){e=t;break}e+=1,e>=plots.length&&(e=0),historyParams.plot=plots[e].name,replaceHistoryWithParams(Object.assign(historyParams,plots[e].forcedDefaults)),parseUrlParams(),start()}else 90==e.keyCode||"z"==e.key||"Z"==e.key?"window"==plotsByName[historyParams.plot].calcFrom?(historyParams.lineWidth=sanityCheckLineWidth(historyParams.lineWidth+1,!0,plotsByName[historyParams.plot]),start()):(historyParams.lineWidth=sanityCheckLineWidth(historyParams.lineWidth+.5,!0,plotsByName[historyParams.plot]),redraw()):72==e.keyCode||"h"==e.key||"H"==e.key?helpVisible?closeHelpMenu():openHelpMenu():79==e.keyCode||"o"==e.key||"O"==e.key?controlsVisible?closeControlsMenu():openControlsMenu():80==e.keyCode||"p"==e.key||"P"==e.key?menuVisible?closeMenu():openMenu():"r"==e.key||"R"==e.key||82==e.keyCode?(showMousePosition=!showMousePosition)||(repaintOnly(),imageParametersCaption&&drawImageParameters()):"t"==e.key||"T"==e.key||84==e.keyCode?(imageParametersCaption=!imageParametersCaption)?drawImageParameters():repaintOnly():"y"==e.key||"Y"==e.key||89==e.keyCode?(workersCount>1&&workersCount--,workersSelect.value=workersCount,changeWorkersCount()):"u"==e.key||"U"==e.key||85==e.keyCode?(workersCount<32&&workersCount++,workersSelect.value=workersCount,changeWorkersCount()):"Escape"==e.key||27==e.keyCode?(useWorkers||(windowCalc.stage=windowCalcStages.stop),stopWorkers(),repaintOnly()):49==e.keyCode||97==e.keyCode||"1"==e.key?activatePreset(presets[0]):50==e.keyCode||98==e.keyCode||"2"==e.key?activatePreset(presets[1]):51==e.keyCode||99==e.keyCode||"3"==e.key?activatePreset(presets[2]):52==e.keyCode||100==e.keyCode||"4"==e.key?activatePreset(presets[3]):53!=e.keyCode&&101!=e.keyCode&&"5"!=e.key||activatePreset(presets[4])})),window.addEventListener("resize",(function(){null!==resizeTimeout&&window.clearTimeout(resizeTimeout),autoResize?resizeTimeout=window.setTimeout(resizeCanvas,500):console.log("ignoring window resize event")}));var mouseDownHandler=function(e){if(e.preventDefault(),!("button"in e)||0==e.button){if(shiftPressed){let t=Math.round(e.pageX-dCanvas.width/2),n=Math.round(dCanvas.height-e.pageY-dCanvas.height/2),o=infNum(BigInt(t),0n),a=infNum(BigInt(n),0n),i=infNumAdd(infNumMul(o,windowCalc.eachPixUnits),historyParams.centerX),r=infNumAdd(infNumMul(a,windowCalc.eachPixUnits),historyParams.centerY);return historyParams.centerX=i,historyParams.centerY=r,previewImageOffsetX-=t,previewImageOffsetY+=n,drawPreviewImage(),void redraw()}"touches"in e&&"1"in e.touches&&(pinch=!0,pinchStartDist=Math.hypot(e.touches[0].pageX-e.touches[1].pageX,e.touches[0].pageY-e.touches[1].pageY)),mouseDrag=!0,mouseDragX=e.pageX,mouseDragY=e.pageY}};dCanvas.addEventListener("mousedown",mouseDownHandler),dCanvas.addEventListener("touchstart",mouseDownHandler);var mouseMoveHandler=function(e){if(e.preventDefault(),!mouseDrag){if(showMousePosition){let t=convertPixelPosToPlanePos(e.pageX,e.pageY);drawMousePosNotice(t.x,t.y)}return}const t=e.pageX,n=e.pageY,o=mouseDragX-t,a=mouseDragY-n,i=infNumMul(infNum(BigInt(o),0n),windowCalc.eachPixUnits),r=infNumMul(infNum(BigInt(a),0n),windowCalc.eachPixUnits);if(historyParams.centerX=infNumAdd(historyParams.centerX,i),historyParams.centerY=infNumSub(historyParams.centerY,r),mouseDragX=t,mouseDragY=n,previewImageOffsetX-=o,previewImageOffsetY-=a,"touches"in e&&"1"in e.touches){const t=(e.touches[0].pageX+e.touches[1].pageX)/2,n=(e.touches[0].pageY+e.touches[1].pageY)/2,o=historyParams.scale,a=Math.hypot(e.touches[0].pageX-e.touches[1].pageX,e.touches[0].pageY-e.touches[1].pageY),i=a/pinchStartDist;pinchStartDist=a;const r=infNumMul(historyParams.scale,createInfNum(i.toString())),l=createInfNum("500"),s=createInfNum("0.00005");if("sequence"==plotsByName[historyParams.plot].calcFrom)infNumLt(r,s)?historyParams.scale=s:infNumGt(r,l)?historyParams.scale=l:historyParams.scale=r;else{if("minScale"in plotsByName[historyParams.plot].privContext&&infNumLt(r,plotsByName[historyParams.plot].privContext.minScale))return;historyParams.scale=r}const c=calculateNewZoomCenterX(createInfNum(t.toString()),createInfNum(dCanvas.width.toString()),historyParams.centerX,o,historyParams.scale),d=calculateNewZoomCenterY(createInfNum(n.toString()),createInfNum(dCanvas.height.toString()),historyParams.centerY,o,historyParams.scale);historyParams.centerX=c,historyParams.centerY=d}redraw()};dCanvas.addEventListener("mousemove",mouseMoveHandler),dCanvas.addEventListener("touchmove",mouseMoveHandler);var mouseUpHandler=function(e){e.preventDefault(),mouseDrag=!1,pinch=!1,annotateClickPosition&&drawAnnotationAtPixelPosition(e.pageX,e.pageY)};function calculateNewZoomCenterX(e,t,n,o,a){const i=infNumSub(n,infNumDiv(infNumDiv(t,infNum(2n,0n),precision),o,precision)),r=infNumAdd(infNumDiv(e,o,precision),i),l=infNumDiv(o,a,precision);return infNumAdd(infNumSub(r,infNumMul(r,l)),infNumMul(n,l))}function calculateNewZoomCenterY(e,t,n,o,a){const i=infNumAdd(n,infNumDiv(infNumDiv(t,infNum(2n,0n),precision),o,precision)),r=infNumSub(i,infNumDiv(e,o,precision)),l=infNumDiv(o,a,precision);return infNumAdd(infNumSub(infNumMul(n,l),infNumMul(r,l)),r)}function closeMenu(){menuVisible=!1,hideFooter(),document.getElementById("menu").style.display="none",document.getElementById("menu-open-wrap").style.display="block"}function openMenu(){menuVisible=!0,closeHelpMenu(),closeControlsMenu(),showFooter(),document.getElementById("menu").style.display="block",document.getElementById("menu-open-wrap").style.display="none"}function closeHelpMenu(){helpVisible=!1,hideFooter(),document.getElementById("help-menu").style.display="none",document.getElementById("menu-open-wrap").style.display="block"}function openHelpMenu(){closeMenu(),closeControlsMenu(),showFooter(),helpVisible=!0,document.getElementById("help-menu").style.display="block",document.getElementById("menu-open-wrap").style.display="none"}function closeControlsMenu(){controlsVisible=!1,hideFooter(),document.getElementById("controls-menu").style.display="none",document.getElementById("menu-open-wrap").style.display="block"}function openControlsMenu(){closeMenu(),closeHelpMenu(),showFooter(),controlsVisible=!0,document.getElementById("controls-menu").style.display="block",document.getElementById("menu-open-wrap").style.display="none",updateGradientPreview()}function showFooter(){document.getElementById("footer").style.display="block"}function hideFooter(){document.getElementById("footer").style.display="none"}dCanvas.addEventListener("mouseup",mouseUpHandler),dCanvas.addEventListener("touchend",mouseUpHandler),dCanvas.addEventListener("wheel",(function(e){const t=historyParams.scale;var n=createInfNum((1+e.wheelDeltaY/48*.05).toString());infNumLt(n,createInfNum("0"))&&(console.log("NEGATIVE scale factor would have been applied: ["+infNumToString(n)+"]"),n=createInfNum("0.05"));const o=infNumMul(historyParams.scale,n),a=createInfNum("5000000000"),i=createInfNum("0.00005");if("sequence"==plotsByName[historyParams.plot].calcFrom)infNumLt(o,i)?historyParams.scale=i:infNumGt(o,a)?historyParams.scale=a:historyParams.scale=o;else{if("minScale"in plotsByName[historyParams.plot].privContext&&infNumLt(o,plotsByName[historyParams.plot].privContext.minScale))return;historyParams.scale=o}const r=calculateNewZoomCenterX(createInfNum(e.pageX.toString()),createInfNum(dCanvas.width.toString()),historyParams.centerX,t,historyParams.scale),l=calculateNewZoomCenterY(createInfNum(e.pageY.toString()),createInfNum(dCanvas.height.toString()),historyParams.centerY,t,historyParams.scale);historyParams.centerX=r,historyParams.centerY=l,redraw()})),document.getElementById("menu-open").addEventListener("click",(function(e){openMenu()}),!0),document.getElementById("menu-close").addEventListener("click",(function(e){closeMenu(),closeHelpMenu(),closeControlsMenu()}),!0),document.getElementById("help-menu-open").addEventListener("click",(function(e){openHelpMenu()}),!0),document.getElementById("help-menu-close").addEventListener("click",(function(e){closeMenu(),closeHelpMenu(),closeControlsMenu()}),!0),document.getElementById("controls-menu-open").addEventListener("click",(function(e){openControlsMenu()}),!0),document.getElementById("controls-menu-close").addEventListener("click",(function(e){closeMenu(),closeHelpMenu(),closeControlsMenu()}),!0),buildGradient("rygb"),setDScaleVarsNoScale(dContext),parseUrlParams(),start();